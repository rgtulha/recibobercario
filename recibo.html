<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Recibos Simples</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFBF8; /* Warm Neutral Background */
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 250px;
            max-height: 300px;
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.5);
        }
        /* Estilos para o calendário */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            text-align: center;
        }
        .calendar-day {
            padding: 6px 0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background-color 0.2s;
        }
        .calendar-day.header {
            font-weight: 600;
            background-color: #e0e7ff; /* Light blue for headers */
            color: #4338ca; /* Darker blue for headers */
        }
        .calendar-day.current-month {
            background-color: #f0f4f8; /* Light gray for current month days */
            color: #4a5568; /* Darker gray for current month days */
        }
        .calendar-day.other-month {
            background-color: #f8fafc; /* Lighter gray for other month days */
            color: #a0aec0; /* Lighter gray for other month days */
        }
        .calendar-day.selected-absence {
            background-color: #fca5a5; /* Red for absences */
            color: #7f1d1d; /* Darker red for absences */
            font-weight: 600;
        }
        .calendar-day.selected-certificate {
            background-color: #a7f3d0; /* Green for certificates */
            color: #065f46; /* Darker green for certificates */
            font-weight: 600;
        }
        .calendar-day.holiday {
            background-color: #fbd38d; /* Orange for holidays */
            color: #92400e; /* Darker orange for holidays */
            font-weight: 600;
        }
        .calendar-day.today {
            border: 2px solid #3b82f6; /* Blue border for today */
        }
        .calendar-day:hover:not(.disabled-for-marking) {
            background-color: #bfdbfe; /* Light blue on hover */
        }
        .calendar-day.disabled-for-marking {
            cursor: not-allowed;
            opacity: 0.6;
            background-color: #e2e8f0; /* Lighter gray for disabled days */
        }
        .employee-item.selected {
            background-color: #d1fae5; /* Light green for selected employee */
            font-weight: 600;
            border-color: #10b981;
        }
        @media print {
            .no-print {
                display: none !important; /* Ensure print button and sidebar are hidden */
            }
            main {
                display: block;
                padding: 0;
                margin: 0;
            }
            aside {
                display: none !important; /* Hide the sidebar completely */
            }
            #receipt-section {
                margin: 0;
                padding: 0;
                border: none;
                box-shadow: none;
                width: 100%;
                max-width: 100%;
                /* Remove background color for cleaner print */
                background-color: transparent !important; 
            }
            #receipt-content {
                display: block !important; /* Ensure receipt content is visible */
            }
            #welcome-message {
                display: none !important; /* Hide welcome message */
            }
            .chart-container {
                display: none !important; /* Hide the chart */
            }
            .modal {
                display: none !important; /* Hide all modals */
            }
            /* Adjust receipt content for better print layout */
            #receipt-content > div { /* The main white box containing receipt details */
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
            }
        }
    </style>
</head>
<body>

    <main class="flex flex-col md:flex-row w-full min-h-screen">
        
        <aside class="w-full md:w-1/3 lg:w-1/4 p-6 bg-white border-r border-stone-200 no-print shadow-xl rounded-lg">
            <h1 class="text-2xl font-bold text-stone-800 mb-1">Gerenciador de Recibos</h1>
            <p class="text-sm text-stone-500 mb-4">Siga os passos para gerar o recibo.</p>
            
            <!-- Removed User ID Display - not needed for local storage -->

            <h2 class="text-lg font-semibold text-stone-700 mb-3">1. Selecione a Funcionária</h2>
            <div class="mt-2 mb-4">
                <input type="text" id="searchInput" placeholder="🔎 Pesquisar funcionária..." class="w-full px-4 py-2 border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
            </div>
            <div id="employeeList" class="overflow-y-auto mb-6" style="max-height: 200px;">
            </div>

            <h2 class="text-lg font-semibold text-stone-700 mb-3">2. Escolha o Tipo de Recibo</h2>
            <div class="mb-6" id="receiptTypeSelection">
                <div class="flex flex-wrap gap-3">
                    <label class="inline-flex items-center">
                        <input type="radio" name="receiptType" value="valeTransporte" class="form-radio text-teal-600" checked>
                        <span class="ml-2 text-stone-700">Vale Transporte</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="receiptType" value="salarioEstagiario" class="form-radio text-teal-600">
                        <span class="ml-2 text-stone-700">Salário Estagiário</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="receiptType" value="bonificacao" class="form-radio text-teal-600">
                        <span class="ml-2 text-stone-700">Bonificação</span>
                    </label>
                </div>
            </div>

            <h2 class="text-lg font-semibold text-stone-700 mb-3">3. Defina o Período</h2>
            <div class="mb-4">
                <label for="startDate" class="block text-sm font-medium text-stone-700 mb-1">Data de Início:</label>
                <input type="date" id="startDate" name="startDate" class="w-full px-3 py-2 border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
            </div>
            <div class="mb-4">
                <label for="endDate" class="block text-sm font-medium text-stone-700 mb-1">Data de Fim:</label>
                <input type="date" id="endDate" name="endDate" class="w-full px-3 py-2 border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
            </div>
            <div id="calculateDaysButtonContainer" class="mb-4 hidden"> <!-- Added hidden class here -->
                <button id="calculateDaysButton" class="w-full px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition-colors shadow-md">Calcular Dias Úteis</button>
            </div>
            <div id="periodInfoContainer" class="hidden"> <!-- Added hidden class here -->
                <p class="text-sm text-stone-600 mb-4">Dias Úteis Calculados: <span id="workingDaysInfo" class="font-semibold">0</span></p>
                <p class="text-xs text-stone-500 mb-4">Feriados no Período: <span id="holidaysInPeriod" class="font-semibold text-red-500">Nenhum</span></p>
            </div>

            <div id="internPeriodContainer" class="mb-4 hidden">
                <label for="internPeriod" class="block text-sm font-medium text-stone-700 mb-1">Período do Estagiário:</label>
                <select id="internPeriod" name="internPeriod" class="w-full px-3 py-2 border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                    <option value="matutino">Matutino</option>
                    <option value="vespertino">Vespertino</option>
                </select>
            </div>

            <h2 class="text-lg font-semibold text-stone-700 mb-3">4. Marque Faltas/Atestados</h2>
            <div class="mb-4 p-4 bg-stone-50 rounded-lg border border-stone-200">
                <div class="flex justify-between items-center mb-3">
                    <button id="prevMonth" class="px-3 py-1 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition-colors shadow-sm">&lt;</button>
                    <span id="currentMonthYear" class="font-semibold text-stone-800"></span>
                    <button id="nextMonth" class="px-3 py-1 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition-colors shadow-sm">&gt;</button>
                </div>
                <div id="calendar" class="calendar-grid">
                </div>
                <div class="flex flex-wrap gap-3 mt-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="markType" value="absence" class="form-radio text-red-500" checked>
                        <span class="ml-2 text-stone-700">Marcar Falta</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="markType" value="certificate" class="form-radio text-green-500">
                        <span class="ml-2 text-stone-700">Marcar Atestado</span>
                    </label>
                </div>
                <button id="clearMarkingButton" class="mt-4 w-full px-4 py-2 bg-stone-400 text-white rounded-lg hover:bg-stone-500 transition-colors shadow-md">Limpar Atestados e Faltas</button>
            </div>

            <div class="mt-6">
                <button id="generateReceiptButton" class="w-full px-4 py-3 bg-teal-600 text-white font-bold rounded-lg hover:bg-teal-700 transition-colors shadow-lg">
                    Gerar Recibo
                </button>
            </div>

            <h2 class="text-lg font-semibold text-stone-700 mb-3 mt-6">Gerenciar Funcionárias</h2>
            <div class="mb-4 p-4 bg-stone-50 rounded-lg border border-stone-200">
                <h3 class="text-md font-semibold text-stone-700 mb-3">Adicionar Nova Funcionária</h3>
                <div class="mb-3">
                    <label for="newEmployeeName" class="block text-sm font-medium text-stone-700 mb-1">Nome:</label>
                    <input type="text" id="newEmployeeName" placeholder="Nome completo" class="w-full px-3 py-2 border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                </div>
                <div class="mb-3">
                    <label for="newEmployeeCpf" class="block text-sm font-medium text-stone-700 mb-1">CPF:</label>
                    <input type="text" id="newEmployeeCpf" placeholder="999.999.999-99" maxlength="14" class="w-full px-3 py-2 border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                </div>
                <button id="addEmployeeButton" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-md">Adicionar Funcionária</button>
            </div>
            
            <div class="mt-6">
                <button id="exportEmployeesButton" class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors shadow-md">
                    Exportar Funcionárias (TXT)
                </button>
            </div>

        </aside>

        <section id="receipt-section" class="w-full md:w-2/3 lg:w-3/4 p-6 md:p-10 bg-stone-50/50 shadow-xl rounded-lg">
            <div id="welcome-message" class="flex flex-col items-center justify-center h-full text-center">
                   <div class="p-8 bg-white rounded-xl shadow-sm border border-stone-200">
                    <h2 class="text-3xl font-bold text-teal-700 mb-2">Gerador de Recibos</h2>
                    <p class="text-stone-600 max-w-md">Bem-vindo(a)! Selecione uma funcionária, o tipo de recibo e o período para gerar o recibo.</p>
                </div>
            </div>

            <div id="receipt-content" class="hidden">
                <div class="flex justify-between items-start mb-8 no-print"> <!-- Added no-print class here -->
                    <h2 id="receipt-title" class="text-4xl font-bold text-stone-800">Recibo</h2>
                    <button onclick="window.print()" class="no-print px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors flex items-center gap-2 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M5 1a2 2 0 0 0-2 2v1h10V3a2 2 0 0 0-2-2H5zm5 8H6a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1z"/>
                            <path d="M0 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1v-2a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v2H2a2 2 0 0 1-2-2V7zm2.5 1a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/>
                        </svg>
                        Imprimir
                    </button>
                </div>

                <div class="bg-white p-8 rounded-xl shadow-lg border border-stone-200">
                    <div class="grid grid-cols-2 gap-x-8 gap-y-4 mb-8 pb-4 border-b-2 border-dashed">
                        <div>
                            <p class="text-sm text-stone-500">Data do Recibo</p>
                            <p id="receipt-date-top" class="text-lg font-semibold text-stone-800"></p>
                        </div>
                        <div class="text-right">
                             <p class="text-sm text-stone-500">VALOR TOTAL</p>
                            <p id="receipt-total" class="text-3xl font-bold text-teal-600"></p>
                        </div>
                    </div>

                    <div class="mb-6">
                        <p class="text-sm text-stone-500 mb-1">Recebido de</p>
                        <p id="receipt-payer" class="text-lg text-stone-800">BERÇÁRIO E ESCOLA CRESCER FELIZ LTDA</p>
                        <p id="receipt-cnpj" class="text-sm text-stone-600">CNPJ: 32.741.557/0001-70</p>
                    </div>

                    <div class="mb-6">
                        <p class="text-sm text-stone-500 mb-1">Nome do(a) Colaborador(a)</p>
                        <p id="employee-name" class="text-lg font-semibold text-stone-800"></p>
                    </div>

                    <div class="mb-8">
                        <p class="text-sm text-stone-500 mb-1">CPF do(a) Colaborador(a)</p>
                        <p id="employee-cpf" class="text-lg text-stone-800"></p>
                    </div>
                    
                    <div class="bg-stone-50 p-6 rounded-lg border border-stone-200">
                        <p class="text-sm text-stone-500 mb-2">Correspondente a:</p>
                        <p id="receipt-description" class="text-base text-stone-700 mb-4">REFERENTE AO VALE TRANSPORTE</p>
                        
                        <div class="text-sm text-stone-600 space-y-1">
                            <p id="receipt-period-info"></p>
                            <p id="receipt-daily-value"></p>
                            <div id="receipt-holidays-info" class="text-red-600 text-xs mt-2"></div>
                        </div>
                        
                        <p class="text-lg text-stone-800 font-semibold mt-4 pt-4 border-t border-stone-200">
                            <span id="receipt-total-words-label">Quantia por extenso: </span><span id="receipt-total-words" class="font-normal"></span>
                        </p>
                    </div>
                    
                    <div class="mt-12 text-center">
                        <p class="border-b-2 border-stone-400 w-3/4 mx-auto pb-1"></p>
                        <p id="employee-signature-name" class="pt-2 text-md font-semibold"></p>
                        <p class="text-sm text-stone-500">Assinatura do(a) Colaborador(a)</p>
                    </div>

                    <!-- Removed receipt-location-date from here -->
                </div>

                <!-- Removed Análise Comparativa de Pagamento and chart section -->
            </div>
        </section>
    </main>

    <!-- Modals -->
    <div id="confirmationModal" class="fixed inset-0 z-50 flex items-center justify-center modal hidden no-print">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-sm w-full mx-4">
            <h3 class="text-xl font-semibold text-stone-800 mb-4">Confirmar Geração de Recibo</h3>
            <p id="modalEmployeeName" class="text-stone-700 mb-6"></p>
            <div class="flex justify-end gap-4">
                <button id="cancelButton" class="px-4 py-2 text-stone-700 bg-stone-200 rounded-lg hover:bg-stone-300 transition-colors shadow-sm">Cancelar</button>
                <button id="confirmButton" class="px-4 py-2 text-white bg-teal-600 rounded-lg hover:bg-teal-700 transition-colors shadow-md">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="messageModal" class="fixed inset-0 z-50 flex items-center justify-center modal hidden no-print">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-sm w-full mx-4">
            <h3 id="messageModalTitle" class="text-xl font-semibold text-stone-800 mb-4">Atenção!</h3>
            <p id="messageModalContent" class="text-stone-700 mb-6"></p>
            <div class="flex justify-end">
                <button id="messageModalCloseButton" class="px-4 py-2 text-white bg-teal-600 rounded-lg hover:bg-teal-700 transition-colors shadow-md">Fechar</button>
            </div>
        </div>
    </div>

    <div id="deleteConfirmationModal" class="fixed inset-0 z-50 flex items-center justify-center modal hidden no-print">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-sm w-full mx-4 border-t-4 border-red-600">
            <h3 class="text-xl font-semibold text-red-700 mb-4">Confirmar Exclusão</h3>
            <p class="text-stone-700 mb-6">Tem certeza que deseja excluir a funcionária <span id="deleteEmployeeName" class="font-bold"></span>?</p>
            <div class="flex justify-end gap-4">
                <button id="cancelDeleteButton" class="px-4 py-2 text-stone-700 bg-stone-200 rounded-lg hover:bg-stone-300 transition-colors shadow-sm">Cancelar</button>
                <button id="confirmDeleteButton" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors shadow-md">Excluir</button>
            </div>
        </div>
    </div>

    <script>
        // Data for employees (now a local array)
        let employeeData = [
            { nome: "ADRIANA GONÇALVES PEREIRA", cpf: "958.678.721-49" },
            { nome: "ADRIANA PEREIRA DA COSTA", cpf: "039.288.382-10" },
            { nome: "ALESSANDRA FERREIRA LEITE", cpf: "880.262.641-34" },
            { nome: "CAROLYNE FERREIRA ANDRADE", cpf: "035.257.371-65" },
            { nome: "DEUZANIR ALVES PEREIRA COSTA", cpf: "014.949.831-41" },
            { nome: "ELLEN PEREIRA DA SILVA", cpf: "054.538.731-08" },
            { nome: "KAROLINE PEREIRA DE ALMEIDA", cpf: "554.958.852-87" },
            { nome: "LEILIANE DO PRADO OLIVEIRA", cpf: "013.560.943-76" },
            { nome: "LUZIA RODRIGUES DE SOUZA", cpf: "702.946.181-98" },
            { nome: "MAIRA APARECIDA DE JESUS SANTOS", cpf: "014.943.541-01" },
            { nome: "MARIA DOMINGAS ARAÚJO DA SILVA", cpf: "052.764.961-96" },
            { nome: "MARILEIA LOPES DOS SANTOS MENDES", cpf: "011.786.881-78" },
            { nome: "RAQUEL DE SOUZA PEREIRA GOMES", cpf: "049.108.801-94" },
            { nome: "ROSENIR MARIA PEREIRA", cpf: "952.935.581-53" },
            { nome: "ROSIRENE GONÇALVES PIRES", cpf: "921.326.186-15" },
            { nome: "VERA LUCIA DE LEMOS PEREIRA DA CRUZ", cpf: "018.455.171-48" },
            { nome: "WATINA LORRAINE MARTINS", cpf: "058.233.501-98" }
        ];

        // Detalhes base do recibo
        const receiptBaseDetails = {
            payer: "BERÇÁRIO E ESCOLA CRESCER FELIZ LTDA",
            cnpj: "32.741.557/0001-70",
            description: "REFERENTE AO VALE TRANSPORTE",
            dailyValue: 8.60, // Valor diário do vale transporte
            fixedBonusAmount: 200.00, // Valor fixo da bonificação
            monthlyAllowance: 1100.00, // Valor fixo mensal da bolsa de estágio
            location: "Goiânia"
        };

        // Feriados de 2025
        const holidays2025 = [ 
            {date: "2025-01-01", name: "Confraternização Universal"},
            {date: "2025-03-03", name: "Carnaval (Ponto Facultativo)"},
            {date: "2025-03-04", name: "Carnaval (Ponto Facultativo)"},
            {date: "2025-04-18", name: "Paixão de Cristo"},
            {date: "2025-04-21", name: "Tiradentes"},
            {date: "2025-05-01", name: "Dia do Trabalho"},
            {date: "2025-06-19", name: "Corpus Christi (Ponto Facultativo)"},
            {date: "2025-09-07", name: "Independência do Brasil"},
            {date: "2025-10-12", name: "Nossa Senhora Aparecida"},
            {date: "2025-10-24", name: "Aniversário de Goiânia"}, 
            {date: "2025-11-02", name: "Finados"},
            {date: "2025-11-15", name: "Proclamação da República"},
            {date: "2025-11-20", name: "Consciência Negra"},
            {date: "2025-12-25", name: "Natal"}
        ];
        
        // Elementos do DOM
        let employeeListEl;
        let searchInputEl;
        let welcomeMessageEl;
        let receiptContentEl;
        let startDateInput;
        let endDateInput;
        let workingDaysInfoEl;
        let calculateDaysButtonEl;
        let holidaysInPeriodEl;
        let calculateDaysButtonContainerEl; 
        let periodInfoContainerEl; 
        
        let confirmationModalEl;
        let modalEmployeeNameEl;
        let confirmButtonEl;
        let cancelButtonEl;

        let receiptTypeSelectionEl;
        let internPeriodContainerEl;
        let internPeriodSelectEl;
        let receiptTitleEl;
        let receiptDateTopEl; 

        // Elementos do calendário
        let calendarEl;
        let currentMonthYearEl;
        let prevMonthBtn;
        let nextMonthBtn;
        let clearMarkingButton;
        let generateReceiptButton;

        // Elementos do novo modal de mensagem
        let messageModalEl;
        let messageModalTitleEl;
        let messageModalContentEl;
        let messageModalCloseButton;

        // Elementos para adicionar/remover funcionárias
        let newEmployeeNameInput;
        let newEmployeeCpfInput;
        let addEmployeeButton;
        let exportEmployeesButton; 

        // Elementos do novo modal de confirmação de exclusão
        let deleteConfirmationModalEl;
        let deleteEmployeeNameEl;
        let cancelDeleteButton;
        let confirmDeleteButton;

        // Removed paymentChart as it's no longer used
        let currentReceiptNumber = 99; // This should ideally be stored persistently too
        let selectedEmployeeForReceipt = null;
        let calculatedWorkingDays = 0;
        let holidaysFoundInPeriod = [];
        let selectedAbsenceDates = new Set(); // Global set for all marked dates
        let selectedCertificateDates = new Set(); // Global set for all marked dates
        let selectedReceiptType = 'valeTransporte';
        let currentCalendarMonth = new Date().getMonth();
        let currentCalendarYear = new Date().getFullYear();
        let currentMarkType = 'absence';
        let employeeToDeleteCpf = null;

        // Variable to control which period is active for calendar marking
        let calendarMarkablePeriod = { start: null, end: null };

        /**
         * Formats a numeric value to Brazilian currency (BRL).
         * @param {number} value - The number to format.
         * @returns {string} The formatted currency string.
         */
        function formatCurrency(value) {
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }
        
        /**
         * Formats a date string (YYYY-MM-DD) to DD/MM/YYYY.
         * @param {string} dateString - The date string in DD-MM-YYYY format.
         * @returns {string} The formatted date string.
         */
        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00'); // Ensures local timezone
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        /**
         * Gets the current date formatted as "DD de [Mês] de AAAA".
         * @returns {string} The formatted current date.
         */
        function getCurrentDateFormatted() {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const monthNames = ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"];
            const month = monthNames[today.getMonth()];
            const year = today.getFullYear();
            return `${day} de ${month} de ${year}`;
        }

        /**
         * Converts a number to its Portuguese word representation for monetary values.
         * Handles numbers up to thousands.
         * @param {number} num - The number to convert.
         * @returns {string} The number in words.
         */
        function numberToWords(num) {
            let numericValue = parseFloat(num);
            if (isNaN(numericValue)) {
                numericValue = 0;
            }

            const [reaisStr, centavosStr] = numericValue.toFixed(2).split('.');
            let reaisNum = parseInt(reaisStr);
            let centavosNum = parseInt(centavosStr);

            const unidades = ["", "um", "dois", "três", "quatro", "cinco", "seis", "sete", "oito", "nove"];
            const especiais = ["dez", "onze", "doze", "treze", "catorze", "quinze", "dezesseis", "dezessete", "dezoito", "dezenove"];
            const dezenas = ["", "", "vinte", "trinta", "quarenta", "cinquenta", "sessenta", "setenta", "oitenta", "noventa"];
            const centenas = ["", "cento", "duzentos", "trezentos", "quatrocentos", "quinhentos", "seiscentos", "setecentos", "oitocentos", "novecentos"];

            function getWordsPart(n) {
                if (n === 0) return "";
                let str = "";

                if (n >= 1000) {
                    if (n === 1000) {
                        str += "mil";
                    } else {
                        str += getWordsPart(Math.floor(n / 1000)) + " mil";
                    }
                    n %= 1000;
                    if (n > 0) str += " e "; // Add "e" if there are remaining hundreds/tens/units
                }

                if (n >= 100) {
                    if (n === 100) str += "cem";
                    else str += centenas[Math.floor(n / 100)];
                    n %= 100;
                    if (n > 0) str += " e ";
                }
                if (n >= 20) {
                    str += dezenas[Math.floor(n / 10)];
                    n %= 10;
                    if (n > 0) str += " e ";
                } else if (n >= 10) {
                    str += especiais[n - 10];
                    n = 0;
                }
                if (n > 0) {
                    str += unidades[n];
                }
                return str;
            }

            let reaisText = getWordsPart(reaisNum);
            if (reaisNum === 0 && centavosNum === 0) reaisText = "zero"; // Changed to "zero" for consistency
            else if (reaisNum === 0) reaisText = ""; // If no reais, don't say "zero reais"
            else reaisText += reaisNum === 1 ? " real" : " reais"; // Changed to lowercase for consistency

            let centavosText = "";
            if (centavosNum > 0) {
                centavosText = getWordsPart(centavosNum);
                centavosText += centavosNum === 1 ? " centavo" : " centavos";
            }
            
            // Combine reais and centavos
            if (reaisNum > 0 && centavosNum > 0) {
                return `${reaisText} e ${centavosText}`;
            } else if (centavosNum > 0) {
                return centavosText;
            } else if (reaisNum > 0) {
                return reaisText;
            } else {
                return "zero reais"; // Fallback for exactly 0.00
            }
        }

        /**
         * Renders the calendar for the current month and year.
         */
        function renderCalendar() {
            calendarEl.innerHTML = '';
            const today = new Date();
            const firstDayOfMonth = new Date(currentCalendarYear, currentCalendarMonth, 1);
            const lastDayOfMonth = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            const firstDayOfWeek = firstDayOfMonth.getDay(); // 0 for Sunday, 1 for Monday, etc.

            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const dayNames = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"];

            currentMonthYearEl.textContent = `${monthNames[currentCalendarMonth]} ${currentCalendarYear}`;

            // Add day headers
            dayNames.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day header';
                dayHeader.textContent = day;
                calendarEl.appendChild(dayHeader);
            });

            // Fill in days from the previous month
            for (let i = 0; i < firstDayOfWeek; i++) {
                const prevMonthDate = new Date(currentCalendarYear, currentCalendarMonth, 0 - (firstDayOfWeek - 1 - i));
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day other-month disabled-for-marking'; // Disable days from other months
                dayEl.textContent = prevMonthDate.getDate();
                calendarEl.appendChild(dayEl);
            }

            // Fill in days of the current month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentCalendarYear, currentCalendarMonth, day);
                const isoDateString = date.toISOString().split('T')[0];
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day current-month';
                dayEl.textContent = day;
                dayEl.dataset.date = isoDateString; // Store ISO date for easy reference

                // Add classes for holidays, absences, certificates, and today
                if (holidays2025.some(h => h.date === isoDateString)) {
                    dayEl.classList.add('holiday');
                }
                if (selectedAbsenceDates.has(isoDateString)) {
                    dayEl.classList.add('selected-absence');
                }
                if (selectedCertificateDates.has(isoDateString)) {
                    dayEl.classList.add('selected-certificate');
                }
                if (isoDateString === today.toISOString().split('T')[0]) {
                    dayEl.classList.add('today');
                }

                // Check if the day is within the active marking period
                if (calendarMarkablePeriod.start && calendarMarkablePeriod.end && 
                    date >= calendarMarkablePeriod.start && date <= calendarMarkablePeriod.end) {
                    dayEl.addEventListener('click', () => toggleDateSelection(isoDateString, dayEl));
                } else {
                    dayEl.classList.add('disabled-for-marking'); // Disable days outside the markable period
                }
                calendarEl.appendChild(dayEl);
            }

            // Fill in days from the next month
            const totalDaysDisplayed = firstDayOfWeek + daysInMonth;
            const remainingDays = 42 - totalDaysDisplayed; // 6 rows * 7 days = 42 cells
            for (let i = 1; i <= remainingDays; i++) {
                const nextMonthDate = new Date(currentCalendarYear, currentCalendarMonth + 1, i);
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day other-month disabled-for-marking'; // Disable days from other months
                dayEl.textContent = nextMonthDate.getDate();
                calendarEl.appendChild(dayEl);
            }
        }

        /**
         * Toggles the selection of a date as an absence, certificate, or clears the marking.
         * @param {string} dateString - The date string in ISO format (YYYY-MM-DD).
         * @param {HTMLElement} element - The calendar day element.
         */
        function toggleDateSelection(dateString, element) {
            const date = new Date(dateString + 'T00:00:00');

            // Impede a marcação se a data estiver fora do período de marcação ativo
            if (!calendarMarkablePeriod.start || !calendarMarkablePeriod.end || 
                date < calendarMarkablePeriod.start || date > calendarMarkablePeriod.end) {
                return;
            }

            if (currentMarkType === 'absence') {
                if (selectedAbsenceDates.has(dateString)) {
                    selectedAbsenceDates.delete(dateString);
                    element.classList.remove('selected-absence');
                } else {
                    selectedAbsenceDates.add(dateString);
                    element.classList.add('selected-absence');
                    selectedCertificateDates.delete(dateString); // Remove de atestado se for marcado como falta
                    element.classList.remove('selected-certificate');
                }
            } else if (currentMarkType === 'certificate') {
                if (selectedCertificateDates.has(dateString)) {
                    selectedCertificateDates.delete(dateString);
                    element.classList.remove('selected-certificate');
                } else {
                    selectedCertificateDates.add(dateString);
                    element.classList.add('selected-certificate');
                    selectedAbsenceDates.delete(dateString); // Remove de falta se for marcado como atestado
                    element.classList.remove('selected-absence');
                }
            }
            // Recalcula os dias efetivos após a alteração
            updateReceiptDisplay(); 
        }

        /**
         * Calculates effective working days within a given date range, considering marked absences/certificates.
         * @param {Date} startDate - The start date of the period.
         * @param {Date} endDate - The end date of the period.
         * @param {Set<string>} absencesSet - Set of ISO date strings for absences.
         * @param {Set<string>} certificatesSet - Set of ISO date strings for certificates.
         * @returns {{effectiveDays: number, absenceDaysCount: number, certificateDaysCount: number, holidaysInPeriod: Array<Object>}} Counts and holidays.
         */
        function calculateDaysForPeriod(startDate, endDate, absencesSet, certificatesSet) {
            let count = 0;
            let absenceCount = 0;
            let certificateCount = 0;
            let currentHolidaysInPeriod = [];
            const currentDate = new Date(startDate);

            while (currentDate <= endDate) {
                const dayOfWeek = currentDate.getDay();
                const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
                
                const isoDateString = currentDate.toISOString().split('T')[0];
                const holiday = holidays2025.find(h => h.date === isoDateString);
                const isHoliday = holiday !== undefined;

                const isAbsenceDay = absencesSet.has(isoDateString);
                const isCertificateDay = certificatesSet.has(isoDateString);

                if (!isWeekend && !isHoliday) {
                    if (!isAbsenceDay && !isCertificateDay) {
                        count++;
                    } else {
                        if (isAbsenceDay) absenceCount++;
                        if (isCertificateDay) certificateCount++;
                    }
                } else if (isHoliday) {
                    currentHolidaysInPeriod.push(holiday);
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return { effectiveDays: count, absenceDaysCount: absenceCount, certificateDaysCount: certificateCount, holidaysInPeriod: currentHolidaysInPeriod };
        }
        
        /**
         * Filters a global set of marked dates (absences or certificates) to find those within a specific month.
         * @param {Set<string>} globalMarkedDatesSet - The global Set of all marked dates.
         * @param {number} year - The year of the target month.
         * @param {number} monthIndex - The 0-indexed month (0-11) of the target month.
         * @returns {Set<string>} A new Set containing only dates from the specified month.
         */
        function getMarkedDatesInSpecificMonth(globalMarkedDatesSet, year, monthIndex) {
            const startOfMonth = new Date(year, monthIndex, 1);
            const endOfMonth = new Date(year, monthIndex + 1, 0);
            const filteredDates = Array.from(globalMarkedDatesSet).filter(dateString => {
                const date = new Date(dateString + 'T00:00:00'); // Ensure date is treated as local time
                return date >= startOfMonth && date <= endOfMonth;
            });
            return new Set(filteredDates);
        }

        /**
         * Handles the change of the selected receipt type.
         * Updates calendar display and marking period, then refreshes receipt display.
         */
        function handleReceiptTypeChange() {
            selectedReceiptType = document.querySelector('input[name="receiptType"]:checked').value;
            
            // Hide intern period container by default
            internPeriodContainerEl.classList.add('hidden');
            
            const mainPeriodStartDate = startDateInput.value ? new Date(startDateInput.value + 'T00:00:00') : null;
            const mainPeriodEndDate = endDateInput.value ? new Date(endDateInput.value + 'T00:00:00') : null;

            if (selectedReceiptType === 'salarioEstagiario') {
                internPeriodContainerEl.classList.remove('hidden');
            }

            // Toggle visibility of "Calcular Dias" button and period info based on receipt type
            if (selectedReceiptType === 'valeTransporte' || selectedReceiptType === 'salarioEstagiario' || selectedReceiptType === 'bonificacao') {
                calculateDaysButtonContainerEl.classList.add('hidden');
                periodInfoContainerEl.classList.add('hidden');
            } else { 
                calculateDaysButtonContainerEl.classList.remove('hidden');
                periodInfoContainerEl.classList.remove('hidden');
            }


            // Adjust calendar display and marking period based on receipt type
            if (selectedReceiptType === 'valeTransporte' && mainPeriodStartDate) {
                // For Vale Transporte, calendar shows previous month, and only allows marking there
                const prevMonthDate = new Date(mainPeriodStartDate.getFullYear(), mainPeriodStartDate.getMonth() - 1, 1);
                currentCalendarMonth = prevMonthDate.getMonth();
                currentCalendarYear = prevMonthDate.getFullYear();
                calendarMarkablePeriod.start = prevMonthDate;
                calendarMarkablePeriod.end = new Date(mainPeriodStartDate.getFullYear(), mainPeriodStartDate.getMonth(), 0); // Last day of previous month
            } else if (mainPeriodStartDate && mainPeriodEndDate) {
                // For other types, calendar shows current selected period, and allows marking within it
                currentCalendarMonth = mainPeriodStartDate.getMonth();
                currentCalendarYear = mainPeriodStartDate.getFullYear();
                calendarMarkablePeriod.start = mainPeriodStartDate;
                calendarMarkablePeriod.end = mainPeriodEndDate;
            } else {
                // No valid dates selected, disable marking
                currentCalendarMonth = new Date().getMonth(); // Default to current month for display
                currentCalendarYear = new Date().getFullYear();
                calendarMarkablePeriod.start = null;
                calendarMarkablePeriod.end = null;
            }

            renderCalendar(); // Re-render calendar with new settings
            updateReceiptDisplay(); // Update receipt content
        }

        /**
         * Helper function to capitalize the first letter of each word in a string.
         * @param {string} str - The input string.
         * @returns {string} The capitalized string.
         */
        function capitalizeWords(str) {
            return str.replace(/\b\w/g, char => char.toUpperCase());
        }

        /**
         * Renders the list of employees based on a search filter.
         * @param {string} filter - The search string.
         */
        function renderEmployeeList(filter = '') {
            employeeListEl.innerHTML = '';
            const filteredData = employeeData.filter(emp => emp.nome.toLowerCase().includes(filter.toLowerCase()));
            
            if (filteredData.length === 0) {
                employeeListEl.innerHTML = `<p class="text-stone-500 p-4 text-center">Nenhuma funcionária encontrada.</p>`;
                return;
            }

            filteredData.forEach(employee => {
                const item = document.createElement('div');
                item.className = 'p-3 mb-2 rounded-lg cursor-pointer hover:bg-teal-50 border-b border-stone-200 employee-item flex justify-between items-center';
                item.innerHTML = `
                    <span>${employee.nome}</span>
                    <button class="text-red-500 hover:text-red-700 ml-2" data-cpf="${employee.cpf}" type="button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                        </svg>
                    </button>
                `;
                item.dataset.cpf = employee.cpf; // Store CPF for easy access
                
                // Add event listener for the employee item (excluding the delete button)
                item.addEventListener('click', (event) => {
                    if (!event.target.closest('button')) {
                        selectEmployee(employee, item);
                    }
                });

                // Add event listener for the delete button
                const deleteButton = item.querySelector('button');
                deleteButton.addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevent employee selection when clicking delete
                    showDeleteConfirmationModal(employee.cpf, employee.nome); // Pass CPF as ID for local array
                });

                employeeListEl.appendChild(item);
            });
            // Add 'selected' class if employee is already selected
            if (selectedEmployeeForReceipt) {
                const currentSelectedEl = employeeListEl.querySelector(`[data-cpf="${selectedEmployeeForReceipt.cpf}"]`);
                if (currentSelectedEl) {
                    currentSelectedEl.classList.add('selected');
                }
            }
        }

        /**
         * Selects an employee and updates the UI.
         * @param {object} employee - The selected employee object.
         * @param {HTMLElement} element - The HTML element representing the selected employee.
         */
        function selectEmployee(employee, element) {
            // Remove 'selected' class from any previously selected employee
            const currentlySelected = employeeListEl.querySelector('.employee-item.selected');
            if (currentlySelected) {
                currentlySelected.classList.remove('selected');
            }
            // Add 'selected' class to the clicked employee
            element.classList.add('selected');
            selectedEmployeeForReceipt = employee;
            showMessageModal("Funcionária Selecionada", `Funcionária selecionada: ${employee.nome}`);

            // Clear all fields when selecting a new employee
            startDateInput.value = '';
            endDateInput.value = '';
            workingDaysInfoEl.textContent = "0";
            holidaysInPeriodEl.textContent = "Nenhum";
            selectedAbsenceDates.clear();
            selectedCertificateDates.clear();
            
            // Reset calendar to current month
            const today = new Date();
            currentCalendarMonth = today.getMonth();
            currentCalendarYear = today.getFullYear();
            
            // Re-evaluate calendarMarkablePeriod based on the default receipt type and new employee selection
            handleReceiptTypeChange(); // This will also call renderCalendar and updateReceiptDisplay

            // Hide receipt content and show welcome message
            receiptContentEl.classList.add('hidden');
            welcomeMessageEl.classList.remove('hidden');
        }

        /**
         * Formats the CPF input field.
         * @param {Event} event - The input event.
         */
        function formatCpfInput(event) {
            let value = event.target.value.replace(/\D/g, ''); // Remove all non-digits
            let formattedValue = '';

            if (value.length > 0) {
                formattedValue += value.substring(0, 3);
                if (value.length > 3) {
                    formattedValue += '.' + value.substring(3, 6);
                }
                if (value.length > 6) {
                    formattedValue += '.' + value.substring(6, 9);
                }
                if (value.length > 9) {
                    formattedValue += '-' + value.substring(9, 11);
                }
            }
            event.target.value = formattedValue;
        }

        /**
         * Adds a new employee to the local employeeData array.
         */
        function addEmployee() {
            const name = newEmployeeNameInput.value.trim();
            const cpf = newEmployeeCpfInput.value.trim();

            if (!name || !cpf) {
                showMessageModal("Erro de Entrada", "Por favor, preencha o nome e o CPF da nova funcionária.");
                return;
            }

            // Basic CPF format validation
            const cpfRegex = /^\d{3}\.\d{3}\.\d{3}-\d{2}$/;
            if (!cpfRegex.test(cpf)) {
                showMessageModal("Erro de CPF", "Por favor, insira um CPF válido no formato XXX.XXX.XXX-XX.");
                return;
            }

            // Check if CPF already exists
            if (employeeData.some(emp => emp.cpf === cpf)) {
                showMessageModal("Erro de CPF", "Já existe uma funcionária com este CPF.");
                return;
            }
            
            const capitalizedName = capitalizeWords(name);

            employeeData.push({ nome: capitalizedName, cpf: cpf });
            renderEmployeeList(); // Re-render the list to show the new employee
            newEmployeeNameInput.value = '';
            newEmployeeCpfInput.value = '';
            showMessageModal("Sucesso", `Funcionária "${capitalizedName}" adicionada com sucesso!`);
        }

        /**
         * Removes an employee from the local employeeData array after confirmation.
         * @param {string} employeeCpf - The CPF of the employee to delete.
         */
        function performRemoveEmployee(employeeCpf) {
            const initialLength = employeeData.length;
            employeeData = employeeData.filter(emp => emp.cpf !== employeeCpf);
            
            if (employeeData.length < initialLength) {
                renderEmployeeList(); // Re-render the list after removal
                // If the removed employee was the selected one, clear selection
                if (selectedEmployeeForReceipt && selectedEmployeeForReceipt.cpf === employeeCpf) {
                    selectedEmployeeForReceipt = null;
                    receiptContentEl.classList.add('hidden');
                    welcomeMessageEl.classList.remove('hidden');
                }
                showMessageModal("Sucesso", `Funcionária removida com sucesso!`);
            } else {
                showMessageModal("Erro", "Funcionária não encontrada.");
            }
            employeeToDeleteCpf = null; // Clear the temporary storage
        }

        /**
         * Displays the confirmation modal before generating the receipt.
         */
        function showConfirmationModal() {
            if (!selectedEmployeeForReceipt) {
                showMessageModal("Erro de Seleção", "Por favor, selecione uma funcionária antes de gerar o recibo.");
                return;
            }

            // Ensure the receipt display is updated just before confirmation to get latest values
            updateReceiptDisplay();

            const { effectiveDays, absenceDaysCount, certificateDaysCount } = 
                calculateDaysForPeriod(new Date(startDateInput.value + 'T00:00:00'), new Date(endDateInput.value + 'T00:00:00'), selectedAbsenceDates, selectedCertificateDates);


            // Check if the period is valid before showing the modal
            const startDate = new Date(startDateInput.value + 'T00:00:00');
            const endDate = new Date(endDateInput.value + 'T00:00:00');
            if (isNaN(startDate) || isNaN(endDate) || startDate > endDate || startDate.getMonth() !== endDate.getMonth() || startDate.getFullYear() !== endDate.getFullYear()) {
                showMessageModal("Erro de Período", "Por favor, selecione um período válido e que esteja contido no mesmo mês antes de gerar um recibo.");
                return;
            }
            
            // For Bonificação, we now generate with 0 if there's absence/certificate, so no early return here.
            // Check for other types: if selectedReceiptType is not VT and not Bonificação, and effectiveDays is 0, show error.
            if (selectedReceiptType !== 'valeTransporte' && selectedReceiptType !== 'bonificacao' && effectiveDays <= 0) { 
                 showMessageModal("Erro de Dias Úteis", "O período selecionado não resultou em dias úteis efetivos. Verifique as datas, feriados, faltas e atestados.");
                 return;
            }

            // For Vale Transporte, check previous month absences for confirmation logic
            if (selectedReceiptType === 'valeTransporte') {
                const currentMonthStartDate = new Date(startDateInput.value + 'T00:00:00');
                const currentMonthEndDate = new Date(endDateInput.value + 'T00:00:00');

                let totalPossibleWorkingDaysInCurrentMonth = 0;
                const tempDate = new Date(currentMonthStartDate);
                while (tempDate <= currentMonthEndDate) {
                    const dayOfWeek = tempDate.getDay();
                    const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
                    const isoDateString = tempDate.toISOString().split('T')[0];
                    const isHoliday = holidays2025.some(h => h.date === isoDateString);
                    if (!isWeekend && !isHoliday) {
                        totalPossibleWorkingDaysInCurrentMonth++;
                    }
                    tempDate.setDate(tempDate.getDate() + 1);
                }

                const prevMonthStartDateForCalc = new Date(currentMonthStartDate.getFullYear(), currentMonthStartDate.getMonth() - 1, 1);
                const prevMonthAbsencesForCalc = getMarkedDatesInSpecificMonth(selectedAbsenceDates, prevMonthStartDateForCalc.getFullYear(), prevMonthStartDateForCalc.getMonth());
                const prevMonthCertificatesForCalc = getMarkedDatesInSpecificMonth(selectedCertificateDates, prevMonthStartDateForCalc.getFullYear(), prevMonthStartDateForCalc.getMonth());

                const effectiveDaysForVTConfirm = totalPossibleWorkingDaysInCurrentMonth - (prevMonthAbsencesForCalc.size + prevMonthCertificatesForCalc.size);

                if (effectiveDaysForVTConfirm <= 0) {
                    showMessageModal("Erro de Dias Úteis", "O período selecionado para Vale Transporte não resultou em dias úteis efetivos, considerando as faltas e atestados do mês anterior.");
                    return;
                }
            }

            modalEmployeeNameEl.textContent = `Gerar recibo para ${selectedEmployeeForReceipt.nome}?`;
            confirmationModalEl.classList.remove('hidden');
        }

        /** Hides the confirmation modal. */
        function hideConfirmationModal() {
            confirmationModalEl.classList.add('hidden');
        }
        
        /**
         * Displays a generic message modal.
         * @param {string} title - The title of the message.
         * @param {string} content - The content of the message.
         */
        function showMessageModal(title, content) {
            messageModalTitleEl.textContent = title;
            messageModalContentEl.textContent = content;
            messageModalEl.classList.remove('hidden');
        }

        /** Hides the generic message modal. */
        function hideMessageModal() {
            messageModalEl.classList.add('hidden');
        }

        /**
         * Displays the delete confirmation modal.
         * @param {string} employeeCpf - The CPF of the employee to delete.
         * @param {string} employeeName - The name of the employee to delete.
         */
        function showDeleteConfirmationModal(employeeCpf, employeeName) {
            employeeToDeleteCpf = employeeCpf; // Store the CPF temporarily
            deleteEmployeeNameEl.textContent = employeeName;
            deleteConfirmationModalEl.classList.remove('hidden');
        }

        /** Hides the delete confirmation modal. */
        function hideDeleteConfirmationModal() {
            deleteConfirmationModalEl.classList.add('hidden');
            employeeToDeleteCpf = null; // Clear temporary storage
        }

        /**
         * Updates the receipt display based on selected employee and receipt type.
         */
        function updateReceiptDisplay() {
            if (!selectedEmployeeForReceipt) {
                receiptContentEl.classList.add('hidden');
                welcomeMessageEl.classList.remove('hidden');
                return;
            }

            welcomeMessageEl.classList.add('hidden');
            receiptContentEl.classList.remove('hidden');
            
            // Set the receipt date at the top
            receiptDateTopEl.textContent = getCurrentDateFormatted();


            let totalValue = 0; 
            let periodText = '';
            let totalWordsLabelText = 'Valor total à receber:'; // Default for new requirements, includes accent
            let dailyValueHtml = '';
            let additionalInfo = ''; // For holidays, absences, certificates info

            const receiptPeriodStartDate = new Date(startDateInput.value + 'T00:00:00');
            const receiptPeriodEndDate = new Date(endDateInput.value + 'T00:00:00');
            const monthNames = ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"];
            const receiptPeriodMonthName = monthNames[receiptPeriodStartDate.getMonth()];

            // Calculate days for the MAIN RECEIPT PERIOD (current month's inputs)
            const { effectiveDays, absenceDaysCount, certificateDaysCount, holidaysInPeriod } = 
                calculateDaysForPeriod(receiptPeriodStartDate, receiptPeriodEndDate, selectedAbsenceDates, selectedCertificateDates);
            
            // Always show holidays for the main receipt period
            if (holidaysInPeriod.length > 0) {
                additionalInfo += `<strong>Feriado(s) no período:</strong><br>${holidaysInPeriod.map(h => `- ${formatDate(h.date)}: ${h.name}`).join('<br>')}`;
            }

            if (selectedReceiptType === 'valeTransporte') {
                // Calculate previous month's dates for absences/certificates affecting VT
                const prevMonthStartDate = new Date(receiptPeriodStartDate.getFullYear(), receiptPeriodStartDate.getMonth() - 1, 1);
                const prevMonthEndDate = new Date(receiptPeriodStartDate.getFullYear(), receiptPeriodStartDate.getMonth(), 0);

                // Get absences and certificates from the previous month's markings
                const prevMonthAbsences = getMarkedDatesInSpecificMonth(selectedAbsenceDates, prevMonthStartDate.getFullYear(), prevMonthStartDate.getMonth());
                const prevMonthCertificates = getMarkedDatesInSpecificMonth(selectedCertificateDates, prevMonthStartDate.getFullYear(), prevMonthStartDate.getMonth());

                // Calculate total possible working days in the *current* receipt month (without current month's marked absences/certs)
                let totalPossibleWorkingDaysInCurrentMonth = 0;
                const tempDate = new Date(receiptPeriodStartDate);
                while (tempDate <= receiptPeriodEndDate) {
                    const dayOfWeek = tempDate.getDay();
                    const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
                    const isoDateString = tempDate.toISOString().split('T')[0];
                    const isHoliday = holidays2025.some(h => h.date === isoDateString);
                    if (!isWeekend && !isHoliday) {
                        totalPossibleWorkingDaysInCurrentMonth++;
                    }
                    tempDate.setDate(tempDate.getDate() + 1);
                }
                
                // --- NEW CALCULATION FOR VALE TRANSPORTE ---
                // Pegar o periodo selecionado multiplicar por 8,6
                let baseValue = totalPossibleWorkingDaysInCurrentMonth * receiptBaseDetails.dailyValue;
                // Cada atestado e/ou falta subtrair 8,6 do resultado da multiplicação dos dias uteis selecionado por 8,6.
                let deduction = (prevMonthAbsences.size + prevMonthCertificates.size) * receiptBaseDetails.dailyValue;
                totalValue = baseValue - deduction;
                // --- END NEW CALCULATION ---

                document.getElementById('receipt-description').textContent = "REFERENTE AO VALE TRANSPORTE";
                
                // --- Updated Period Text for Vale Transporte ---
                periodText = `<strong>Período:</strong> ${totalPossibleWorkingDaysInCurrentMonth} dias úteis efetivos do mês de ${receiptPeriodMonthName} (${formatDate(startDateInput.value)} até ${formatDate(endDateInput.value)}).`;
                // --- End Updated Period Text ---

                dailyValueHtml = `<strong>Valor Diário:</strong> ${formatCurrency(receiptBaseDetails.dailyValue)} (${numberToWords(receiptBaseDetails.dailyValue)})`;
                
                // Get previous month's name for description
                const prevMonthNameForDisplay = monthNames[prevMonthStartDate.getMonth()];

                // List previous month absences/certs in additionalInfo using previous month's name
                if (prevMonthAbsences.size > 0) {
                    additionalInfo += (additionalInfo ? '<br><br>' : '') + `<strong>Falta(s) referente(s) ao mês de ${prevMonthNameForDisplay}:</strong><br>${Array.from(prevMonthAbsences).sort().map(d => `- ${formatDate(d)}`).join('<br>')}`;
                }
                if (prevMonthCertificates.size > 0) {
                    additionalInfo += (additionalInfo ? '<br><br>' : '') + `<strong>Atestado(s) referente(s) ao mês de ${prevMonthNameForDisplay}:</strong><br>${Array.from(prevMonthCertificates).sort().map(d => `- ${formatDate(d)}`).join('<br>')}`;
                }
                totalWordsLabelText = 'Valor total à receber:'; // Specific for VT

            } else if (selectedReceiptType === 'salarioEstagiario') {
                const monthlyAllowance = receiptBaseDetails.monthlyAllowance;
                const fixedDivisorForAbsence = 30; // Always divide by 30 for salary discount
                const dailyAllowance = monthlyAllowance / fixedDivisorForAbsence;
                totalValue = monthlyAllowance - (absenceDaysCount * dailyAllowance); // absenceDaysCount are for current period
                document.getElementById('receipt-description').textContent = `REFERENTE À BOLSA ESTÁGIO (${internPeriodSelectEl.value === 'matutino' ? 'Período Matutino' : 'Período Vespertino'})`;
                
                // --- Updated Period Text for Salário Estagiário (with selected period type) ---
                const internPeriodDisplay = internPeriodSelectEl.value === 'matutino' ? 'Matutino' : 'Vespertino';
                periodText = `<strong>Período:</strong> dias trabalhados do mês de ${receiptPeriodMonthName} (${internPeriodDisplay}) (${formatDate(startDateInput.value)} até ${formatDate(endDateInput.value)}).`;
                // --- End Updated Period Text ---
                
                dailyValueHtml = `<strong>Valor Fixo Mensal:</strong> ${formatCurrency(receiptBaseDetails.monthlyAllowance)} (${numberToWords(receiptBaseDetails.monthlyAllowance)})`;
                totalWordsLabelText = 'Valor Total à receber:'; // Specific for Salário Estagiário

                // List current period absences/certs in additionalInfo
                if (absenceDaysCount > 0) {
                    additionalInfo += (additionalInfo ? '<br><br>' : '') + `<strong>Dia(s) de Falta:</strong><br>${Array.from(selectedAbsenceDates).filter(d => {
                        const date = new Date(d + 'T00:00:00');
                        return date >= receiptPeriodStartDate && date <= receiptPeriodEndDate;
                    }).sort().map(d => `- ${formatDate(d)}`).join('<br>')}`;
                }
                if (certificateDaysCount > 0) {
                    additionalInfo += (additionalInfo ? '<br><br>' : '') + `<strong>Dia(s) de Atestado:</strong><br>${Array.from(selectedCertificateDates).filter(d => {
                        const date = new Date(d + 'T00:00:00');
                        return date >= receiptPeriodStartDate && date <= receiptPeriodEndDate;
                    }).sort().map(d => `- ${formatDate(d)}`).join('<br>')}`;
                }

            } else if (selectedReceiptType === 'bonificacao') {
                // --- NEW LOGIC for Bonificação: Value is 0 if there are absences/certificates ---
                if (absenceDaysCount > 0 || certificateDaysCount > 0) {
                    totalValue = 0; // Set to zero if there's any absence or certificate in the current period
                } else {
                    totalValue = receiptBaseDetails.fixedBonusAmount; 
                }
                // --- END NEW LOGIC ---

                document.getElementById('receipt-description').textContent = `REFERENTE À BONIFICAÇÃO`;
                
                // Period Text for Bonificação (original format) - NO DIAS ÚTEIS EFETIVOS
                periodText = `<strong>Período:</strong> dias trabalhados do mês de ${receiptPeriodMonthName} (${formatDate(startDateInput.value)} até ${formatDate(endDateInput.value)}).`;
                
                dailyValueHtml = `<strong>Valor Fixo Mensal:</strong> ${formatCurrency(receiptBaseDetails.fixedBonusAmount)} (${numberToWords(receiptBaseDetails.fixedBonusAmount)})`; 
                totalWordsLabelText = 'Valor total à receber:'; // Specific for Bonificação
                
                // List current period absences/certs in additionalInfo
                if (absenceDaysCount > 0) {
                    additionalInfo += (additionalInfo ? '<br><br>' : '') + `<strong>Dia(s) de Falta:</strong><br>${Array.from(selectedAbsenceDates).filter(d => {
                        const date = new Date(d + 'T00:00:00');
                        return date >= receiptPeriodStartDate && date <= receiptPeriodEndDate;
                    }).sort().map(d => `- ${formatDate(d)}`).join('<br>')}`;
                }
                if (certificateDaysCount > 0) {
                    additionalInfo += (additionalInfo ? '<br><br>' : '') + `<strong>Dia(s) de Atestado:</strong><br>${Array.from(selectedCertificateDates).filter(d => {
                        const date = new Date(d + 'T00:00:00');
                        return date >= receiptPeriodStartDate && date <= receiptPeriodEndDate;
                    }).sort().map(d => `- ${formatDate(d)}`).join('<br>')}`;
                }
            }

            let words;
            try {
                words = numberToWords(totalValue);
            } catch (e) {
                console.error("Error converting number to words:", e);
                words = "Erro na conversão"; 
            }

            // Update receipt elements
            document.getElementById('receipt-total').textContent = formatCurrency(totalValue);
            document.getElementById('receipt-payer').textContent = receiptBaseDetails.payer;
            document.getElementById('receipt-cnpj').textContent = `CNPJ: ${receiptBaseDetails.cnpj}`;
            document.getElementById('employee-name').textContent = selectedEmployeeForReceipt.nome;
            document.getElementById('employee-cpf').textContent = selectedEmployeeForReceipt.cpf;
            
            document.getElementById('receipt-period-info').innerHTML = periodText;
            document.getElementById('receipt-daily-value').innerHTML = dailyValueHtml;
            document.getElementById('receipt-holidays-info').innerHTML = additionalInfo;

            document.getElementById('receipt-total-words-label').textContent = totalWordsLabelText;
            document.getElementById('receipt-total-words').textContent = words; 
            document.getElementById('employee-signature-name').textContent = selectedEmployeeForReceipt.nome;
            // Removed receipt-location-date update

            // Removed chart update call
            // updateChart(selectedEmployeeForReceipt, totalValue); 
            
            // --- Update Receipt Titles ---
            if (selectedReceiptType === 'valeTransporte') {
                receiptTitleEl.textContent = "Recibo de vale transporte";
            } else if (selectedReceiptType === 'salarioEstagiario') {
                receiptTitleEl.textContent = "Recibo Bolsa Estágio";
            } else if (selectedReceiptType === 'bonificacao') {
                receiptTitleEl.textContent = "Recibo de bonificação";
            } else {
                receiptTitleEl.textContent = "Recibo"; // Default fallback
            }
            // --- End Update Receipt Titles ---
        }

        // Removed the updateChart function as it's no longer used.
        /*
        function updateChart(selectedEmployee, currentTotal) {
            // ... (removed chart logic)
        }
        */
        
        /**
         * Exports employee data to a plain text file for download.
         */
        function exportEmployeesToTxt() {
            let csvContent = "Nome,CPF\n"; // Header row
            employeeData.forEach(employee => {
                csvContent += `${employee.nome},${employee.cpf}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'funcionarias.txt'; // Suggested filename
            document.body.appendChild(link); // Required for Firefox
            link.click(); // Trigger download
            document.body.removeChild(link); // Clean up
            URL.revokeObjectURL(link.href); // Release object URL
            showMessageModal("Exportação Concluída", "Os dados das funcionárias foram exportados para 'funcionarias.txt'. Você pode encontrar o arquivo na sua pasta de downloads.");
        }
        
        // Initialize the app on window load
        window.onload = () => {
            // DOM element references
            employeeListEl = document.getElementById('employeeList');
            searchInputEl = document.getElementById('searchInput');
            welcomeMessageEl = document.getElementById('welcome-message');
            receiptContentEl = document.getElementById('receipt-content');
            startDateInput = document.getElementById('startDate');
            endDateInput = document.getElementById('endDate');
            workingDaysInfoEl = document.getElementById('workingDaysInfo');
            calculateDaysButtonEl = document.getElementById('calculateDaysButton');
            holidaysInPeriodEl = document.getElementById('holidaysInPeriod');
            calculateDaysButtonContainerEl = document.getElementById('calculateDaysButtonContainer'); 
            periodInfoContainerEl = document.getElementById('periodInfoContainer'); 
            
            confirmationModalEl = document.getElementById('confirmationModal');
            modalEmployeeNameEl = document.getElementById('modalEmployeeName');
            confirmButtonEl = document.getElementById('confirmButton');
            cancelButtonEl = document.getElementById('cancelButton');

            receiptTypeSelectionEl = document.getElementById('receiptTypeSelection');
            internPeriodContainerEl = document.getElementById('internPeriodContainer');
            internPeriodSelectEl = document.getElementById('internPeriod');
            receiptTitleEl = document.getElementById('receipt-title');
            receiptDateTopEl = document.getElementById('receipt-date-top'); 

            // Elementos do calendário
            calendarEl = document.getElementById('calendar');
            currentMonthYearEl = document.getElementById('currentMonthYear');
            prevMonthBtn = document.getElementById('prevMonth');
            nextMonthBtn = document.getElementById('nextMonth');
            clearMarkingButton = document.getElementById('clearMarkingButton');
            generateReceiptButton = document.getElementById('generateReceiptButton');

            // Elementos do novo modal de mensagem
            messageModalEl = document.getElementById('messageModal');
            messageModalTitleEl = document.getElementById('messageModalTitle'); 
            messageModalContentEl = document.getElementById('messageModalContent');
            messageModalCloseButton = document.getElementById('messageModalCloseButton');

            // Elementos para adicionar/remover funcionárias
            newEmployeeNameInput = document.getElementById('newEmployeeName');
            newEmployeeCpfInput = document.getElementById('newEmployeeCpf');
            addEmployeeButton = document.getElementById('addEmployeeButton');
            exportEmployeesButton = document.getElementById('exportEmployeesButton'); 

            // Elementos do novo modal de confirmação de exclusão
            deleteConfirmationModalEl = document.getElementById('deleteConfirmationModal');
            deleteEmployeeNameEl = document.getElementById('deleteEmployeeName');
            cancelDeleteButton = document.getElementById('cancelDeleteButton');
            confirmDeleteButton = document.getElementById('confirmDeleteButton'); 

            // Event listener attachments - moved inside window.onload
            searchInputEl.addEventListener('keyup', (e) => renderEmployeeList(e.target.value));
            startDateInput.addEventListener('change', () => {
                // Clear existing markings if the main period changes, as their relevance might shift
                selectedAbsenceDates.clear(); 
                selectedCertificateDates.clear(); 
                // Then update the calendar and receipt display based on new dates and current receipt type
                handleReceiptTypeChange(); // This will handle calendar month/year and marking period update
            });
            endDateInput.addEventListener('change', () => {
                // Clear existing markings if the main period changes, as their relevance might shift
                selectedAbsenceDates.clear(); 
                selectedCertificateDates.clear(); 
                // Then update the calendar and receipt display based on new dates and current receipt type
                handleReceiptTypeChange(); // This will handle calendar month/year and marking period update
            });
            calculateDaysButtonEl.addEventListener('click', updateReceiptDisplay); // Changed to updateReceiptDisplay
            document.querySelectorAll('input[name="receiptType"]').forEach(radio => {
                radio.addEventListener('change', handleReceiptTypeChange);
            });
            prevMonthBtn.addEventListener('click', () => {
                currentCalendarMonth--;
                if (currentCalendarMonth < 0) {
                    currentCalendarMonth = 11;
                    currentCalendarYear--;
                }
                renderCalendar();
            });
            nextMonthBtn.addEventListener('click', () => {
                currentCalendarMonth++;
                if (currentCalendarMonth > 11) {
                    currentCalendarMonth = 0;
                    currentCalendarYear++;
                }
                renderCalendar();
            });
            document.querySelectorAll('input[name="markType"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    currentMarkType = e.target.value;
                });
            });
            clearMarkingButton.addEventListener('click', () => {
                selectedAbsenceDates.clear();
                selectedCertificateDates.clear();
                renderCalendar();
                updateReceiptDisplay(); // Update receipt after clearing
                showMessageModal("Marcações Limpas", "Todas as marcações de falta e atestado foram limpas.");
            });
            generateReceiptButton.addEventListener('click', showConfirmationModal);
            newEmployeeCpfInput.addEventListener('input', formatCpfInput);
            addEmployeeButton.addEventListener('click', addEmployee);
            exportEmployeesButton.addEventListener('click', exportEmployeesToTxt); // Attach export listener
            confirmButtonEl.addEventListener('click', () => {
                if (selectedEmployeeForReceipt) {
                    updateReceiptDisplay(); // Final update on confirm
                }
                hideConfirmationModal();
            });
            cancelButtonEl.addEventListener('click', hideConfirmationModal);
            messageModalCloseButton.addEventListener('click', hideMessageModal);
            confirmDeleteButton.addEventListener('click', () => {
                performRemoveEmployee(employeeToDeleteCpf);
                hideDeleteConfirmationModal();
            });
            cancelDeleteButton.addEventListener('click', hideDeleteConfirmationModal);

            // Initial setup calls
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);

            startDateInput.value = firstDayOfMonth.toISOString().split('T')[0];
            endDateInput.value = lastDayOfMonth.toISOString().split('T')[0];
            
            renderEmployeeList(); // Initial render of the employee list
            // Call handleReceiptTypeChange to correctly set up initial calendar state and receipt display
            handleReceiptTypeChange(); 
        };

    </script>
</body>
</html>
