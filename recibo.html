<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Recibos Avan√ßado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFBF8; /* Warm Neutral Background */
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 250px;
            max-height: 300px;
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.5);
        }
        /* Estilos para o calend√°rio */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            text-align: center;
        }
        .calendar-day {
            padding: 6px 0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background-color 0.2s;
        }
        .calendar-day.header {
            font-weight: 600;
            background-color: #e0e7ff; /* Light blue for headers */
            color: #4338ca; /* Darker blue for headers */
        }
        .calendar-day.current-month {
            background-color: #f0f4f8; /* Light gray for current month days */
            color: #4a5568; /* Darker gray for current month days */
        }
        .calendar-day.other-month {
            background-color: #f8fafc; /* Lighter gray for other month days */
            color: #a0aec0; /* Lighter gray for other month days */
        }
        .calendar-day.selected-absence {
            background-color: #fca5a5; /* Red for absences */
            color: #7f1d1d; /* Darker red for absences */
            font-weight: 600;
        }
        .calendar-day.selected-certificate {
            background-color: #a7f3d0; /* Green for certificates */
            color: #065f46; /* Darker green for certificates */
            font-weight: 600;
        }
        .calendar-day.holiday {
            background-color: #fbd38d; /* Orange for holidays */
            color: #92400e; /* Darker orange for holidays */
            font-weight: 600;
        }
        .calendar-day.today {
            border: 2px solid #3b82f6; /* Blue border for today */
        }
        .calendar-day:hover:not(.disabled-for-marking) {
            background-color: #bfdbfe; /* Light blue on hover */
        }
        .calendar-day.disabled-for-marking {
            cursor: not-allowed;
            opacity: 0.6;
            background-color: #e2e8f0; /* Lighter gray for disabled days */
        }
        .employee-item.selected {
            background-color: #d1fae5; /* Light green for selected employee */
            font-weight: 600;
            border-color: #10b981;
        }
        @media print {
            .no-print {
                display: none;
            }
            main {
                display: block;
                padding: 0;
            }
            #receipt-section {
                margin: 0;
                padding: 0;
                border: none;
                box-shadow: none;
                width: 100%;
            }
            .modal {
                display: none !important;
            }
        }
    </style>
</head>
<body class="text-stone-700">

    <main class="flex flex-col md:flex-row w-full min-h-screen">
        
        <aside class="w-full md:w-1/3 lg:w-1/4 p-6 bg-white border-r border-stone-200 no-print shadow-xl rounded-lg">
            <h1 class="text-2xl font-bold text-stone-800 mb-1">Gerenciador de Recibos</h1>
            <p class="text-sm text-stone-500 mb-4">Siga os passos para gerar o recibo.</p>
            
            <h2 class="text-lg font-semibold text-stone-700 mb-3">1. Selecione a Funcion√°ria</h2>
            <div class="mt-2 mb-4">
                <input type="text" id="searchInput" placeholder="üîé Pesquisar funcion√°ria..." class="w-full px-4 py-2 border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
            </div>
            <div id="employeeList" class="overflow-y-auto mb-6" style="max-height: 200px;">
                </div>

            <h2 class="text-lg font-semibold text-stone-700 mb-3">2. Escolha o Tipo de Recibo</h2>
            <div class="mb-6" id="receiptTypeSelection">
                <div class="flex flex-wrap gap-3">
                    <label class="inline-flex items-center">
                        <input type="radio" name="receiptType" value="valeTransporte" class="form-radio text-teal-600" checked>
                        <span class="ml-2 text-stone-700">Vale Transporte</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="receiptType" value="salarioEstagiario" class="form-radio text-teal-600">
                        <span class="ml-2 text-stone-700">Sal√°rio Estagi√°rio</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="receiptType" value="bonificacao" class="form-radio text-teal-600">
                        <span class="ml-2 text-stone-700">Bonifica√ß√£o</span>
                    </label>
                </div>
            </div>

            <h2 class="text-lg font-semibold text-stone-700 mb-3">3. Defina o Per√≠odo</h2>
            <div class="mb-4">
                <label for="startDate" class="block text-sm font-medium text-stone-700 mb-1">Data de In√≠cio:</label>
                <input type="date" id="startDate" name="startDate" class="w-full px-3 py-2 border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
            </div>
            <div class="mb-4">
                <label for="endDate" class="block text-sm font-medium text-stone-700 mb-1">Data de Fim:</label>
                <input type="date" id="endDate" name="endDate" class="w-full px-3 py-2 border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
            </div>
             <div class="mb-4">
                <button id="calculateDaysButton" class="w-full px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition-colors shadow-md">Calcular Dias √öteis</button>
            </div>
            <p class="text-sm text-stone-600 mb-4">Dias √öteis Calculados: <span id="workingDaysInfo" class="font-semibold">0</span></p>
            <p class="text-xs text-stone-500 mb-4">Feriados no Per√≠odo: <span id="holidaysInPeriod" class="font-semibold text-red-500">Nenhum</span></p>

            <div id="internPeriodContainer" class="mb-4 hidden">
                <label for="internPeriod" class="block text-sm font-medium text-stone-700 mb-1">Per√≠odo do Estagi√°rio:</label>
                <select id="internPeriod" name="internPeriod" class="w-full px-3 py-2 border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                    <option value="matutino">Matutino</option>
                    <option value="vespertino">Vespertino</option>
                </select>
            </div>

            <h2 class="text-lg font-semibold text-stone-700 mb-3">4. Marque Faltas/Atestados</h2>
            <div class="mb-4 p-4 bg-stone-50 rounded-lg border border-stone-200">
                <div class="flex justify-between items-center mb-3">
                    <button id="prevMonth" class="px-3 py-1 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition-colors shadow-sm">&lt;</button>
                    <span id="currentMonthYear" class="font-semibold text-stone-800"></span>
                    <button id="nextMonth" class="px-3 py-1 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition-colors shadow-sm">&gt;</button>
                </div>
                <div id="calendar" class="calendar-grid">
                    </div>
                <div class="flex flex-wrap gap-3 mt-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="markType" value="absence" class="form-radio text-red-500" checked>
                        <span class="ml-2 text-stone-700">Marcar Falta</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="markType" value="certificate" class="form-radio text-green-500">
                        <span class="ml-2 text-stone-700">Marcar Atestado</span>
                    </label>
                </div>
                <button id="clearMarkingButton" class="mt-4 w-full px-4 py-2 bg-stone-400 text-white rounded-lg hover:bg-stone-500 transition-colors shadow-md">Limpar Atestados e Faltas</button>
            </div>

            <div class="mt-6">
                <button id="generateReceiptButton" class="w-full px-4 py-3 bg-teal-600 text-white font-bold rounded-lg hover:bg-teal-700 transition-colors shadow-lg">
                    Gerar Recibo
                </button>
            </div>

            <h2 class="text-lg font-semibold text-stone-700 mb-3 mt-6">Gerenciar Funcion√°rias</h2>
            <div class="mb-4 p-4 bg-stone-50 rounded-lg border border-stone-200">
                <h3 class="text-md font-semibold text-stone-700 mb-3">Adicionar Nova Funcion√°ria</h3>
                <div class="mb-3">
                    <label for="newEmployeeName" class="block text-sm font-medium text-stone-700 mb-1">Nome:</label>
                    <input type="text" id="newEmployeeName" placeholder="Nome completo" class="w-full px-3 py-2 border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                </div>
                <div class="mb-3">
                    <label for="newEmployeeCpf" class="block text-sm font-medium text-stone-700 mb-1">CPF:</label>
                    <input type="text" id="newEmployeeCpf" placeholder="999.999.999-99" class="w-full px-3 py-2 border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                </div>
                <button id="addEmployeeButton" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-md">Adicionar Funcion√°ria</button>
            </div>

        </aside>

        <section id="receipt-section" class="w-full md:w-2/3 lg:w-3/4 p-6 md:p-10 bg-stone-50/50 shadow-xl rounded-lg">
            <div id="welcome-message" class="flex flex-col items-center justify-center h-full text-center">
                 <div class="p-8 bg-white rounded-xl shadow-sm border border-stone-200">
                    <h2 class="text-3xl font-bold text-teal-700 mb-2">Gerador de Recibos</h2>
                    <p class="text-stone-600 max-w-md">Bem-vindo(a)! Selecione uma funcion√°ria, o tipo de recibo e o per√≠odo para gerar o recibo.</p>
                </div>
            </div>

            <div id="receipt-content" class="hidden">
                <div class="flex justify-between items-start mb-8">
                    <h2 id="receipt-title" class="text-4xl font-bold text-stone-800">Recibo de Pagamento</h2>
                    <button onclick="window.print()" class="no-print px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors flex items-center gap-2 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M5 1a2 2 0 0 0-2 2v1h10V3a2 2 0 0 0-2-2H5zm5 8H6a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1z"/>
                            <path d="M0 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1v-2a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v2H2a2 2 0 0 1-2-2V7zm2.5 1a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/>
                        </svg>
                        Imprimir
                    </button>
                </div>

                <div class="bg-white p-8 rounded-xl shadow-lg border border-stone-200">
                    <div class="grid grid-cols-2 gap-x-8 gap-y-4 mb-8 pb-4 border-b-2 border-dashed">
                        <div>
                            <p class="text-sm text-stone-500">N¬∫ do Recibo</p>
                            <p id="receipt-id" class="text-lg font-semibold text-stone-800"></p>
                        </div>
                        <div class="text-right">
                             <p class="text-sm text-stone-500">VALOR TOTAL</p>
                            <p id="receipt-total" class="text-3xl font-bold text-teal-600"></p>
                        </div>
                    </div>

                    <div class="mb-6">
                        <p class="text-sm text-stone-500 mb-1">Recebido de</p>
                        <p id="receipt-payer" class="text-lg text-stone-800">BER√á√ÅRIO E ESCOLA CRESCER FELIZ LTDA</p>
                        <p id="receipt-cnpj" class="text-sm text-stone-600">CNPJ: 32.741.557/0001-70</p>
                    </div>

                    <div class="mb-6">
                        <p class="text-sm text-stone-500 mb-1">Nome do(a) Colaborador(a)</p>
                        <p id="employee-name" class="text-lg font-semibold text-stone-800"></p>
                    </div>

                    <div class="mb-8">
                        <p class="text-sm text-stone-500 mb-1">CPF do(a) Colaborador(a)</p>
                        <p id="employee-cpf" class="text-lg text-stone-800"></p>
                    </div>
                    
                    <div class="bg-stone-50 p-6 rounded-lg border border-stone-200">
                        <p class="text-sm text-stone-500 mb-2">Correspondente a:</p>
                        <p id="receipt-description" class="text-base text-stone-700 mb-4">REFERENTE AO VALE TRANSPORTE</p>
                        
                        <div class="text-sm text-stone-600 space-y-1">
                            <p id="receipt-period-info"></p>
                            <p id="receipt-daily-value"></p>
                            <div id="receipt-holidays-info" class="text-red-600 text-xs mt-2"></div>
                        </div>
                        
                        <p class="text-lg text-stone-800 font-semibold mt-4 pt-4 border-t border-stone-200">
                            Quantia por extenso: <span id="receipt-total-words" class="font-normal"></span>
                        </p>
                    </div>
                    
                    <div class="mt-12 text-center">
                        <p class="border-b-2 border-stone-400 w-3/4 mx-auto pb-1"></p>
                        <p id="employee-signature-name" class="pt-2 text-md font-semibold"></p>
                        <p class="text-sm text-stone-500">Assinatura do(a) Colaborador(a)</p>
                    </div>

                    <div class="mt-8 text-center text-sm text-stone-500">
                        <p id="receipt-location-date">Goi√¢nia, <span id="current-date-receipt"></span>.</p>
                    </div>
                </div>

                <div class="mt-10 pt-6 border-t border-stone-200">
                    <h3 class="text-xl font-bold text-stone-800 mb-4 text-center">An√°lise Comparativa de Pagamento</h3>
                    <p class="text-center text-stone-600 mb-6 max-w-2xl mx-auto">Este gr√°fico compara o valor do vale transporte da funcion√°ria selecionada com a m√©dia de pagamentos (valor fixo para demonstra√ß√£o).</p>
                    <div class="chart-container">
                        <canvas id="paymentChart"></canvas>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="confirmationModal" class="fixed inset-0 z-50 flex items-center justify-center modal hidden no-print">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-sm w-full mx-4">
            <h3 class="text-xl font-semibold text-stone-800 mb-4">Confirmar Gera√ß√£o de Recibo</h3>
            <p id="modalEmployeeName" class="text-stone-700 mb-6"></p>
            <div class="flex justify-end gap-4">
                <button id="cancelButton" class="px-4 py-2 text-stone-700 bg-stone-200 rounded-lg hover:bg-stone-300 transition-colors shadow-sm">Cancelar</button>
                <button id="confirmButton" class="px-4 py-2 text-white bg-teal-600 rounded-lg hover:bg-teal-700 transition-colors shadow-md">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="messageModal" class="fixed inset-0 z-50 flex items-center justify-center modal hidden no-print">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-sm w-full mx-4">
            <h3 id="messageModalTitle" class="text-xl font-semibold text-stone-800 mb-4">Aten√ß√£o!</h3>
            <p id="messageModalContent" class="text-stone-700 mb-6"></p>
            <div class="flex justify-end">
                <button id="messageModalCloseButton" class="px-4 py-2 text-white bg-teal-600 rounded-lg hover:bg-teal-700 transition-colors shadow-md">Fechar</button>
            </div>
        </div>
    </div>

    <div id="deleteConfirmationModal" class="fixed inset-0 z-50 flex items-center justify-center modal hidden no-print">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-sm w-full mx-4 border-t-4 border-red-600">
            <h3 class="text-xl font-semibold text-red-700 mb-4">Confirmar Exclus√£o</h3>
            <p class="text-stone-700 mb-6">Tem certeza que deseja excluir a funcion√°ria <span id="deleteEmployeeName" class="font-bold"></span>?</p>
            <div class="flex justify-end gap-4">
                <button id="cancelDeleteButton" class="px-4 py-2 text-stone-700 bg-stone-200 rounded-lg hover:bg-stone-300 transition-colors shadow-sm">Cancelar</button>
                <button id="confirmDeleteButton" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors shadow-md">Excluir</button>
            </div>
        </div>
    </div>

    <script>
        // Dados das funcion√°rias
        let employeeData = [ // Changed to 'let' to allow modification
            { nome: "ADRIANA GON√áALVES PEREIRA", cpf: "958.678.721-49" },
            { nome: "ADRIANA PEREIRA DA COSTA", cpf: "039.288.382-10" },
            { nome: "ALESSANDRA FERREIRA LEITE", cpf: "880.262.641-34" },
            { nome: "CAROLYNE FERREIRA ANDRADE", cpf: "035.257.371-65" },
            { nome: "DEUZANIR ALVES PEREIRA COSTA", cpf: "014.949.831-41" },
            { nome: "ELLEN PEREIRA DA SILVA", cpf: "054.538.731-08" },
            { nome: "KAROLINE PEREIRA DE ALMEIDA", cpf: "554.958.852-87" },
            { nome: "LEILIANE DO PRADO OLIVEIRA", cpf: "013.560.943-76" },
            { nome: "LUZIA RODRIGUES DE SOUZA", cpf: "702.946.181-98" },
            { nome: "MAIRA APARECIDA DE JESUS SANTOS", cpf: "014.943.541-01" },
            { nome: "MARIA DOMINGAS ARA√öJO DA SILVA", cpf: "052.764.961-96" },
            { nome: "MARILEIA LOPES DOS SANTOS MENDES", cpf: "011.786.881-78" },
            { nome: "RAQUEL DE SOUZA PEREIRA GOMES", cpf: "049.108.801-94" },
            { nome: "ROSENIR MARIA PEREIRA", cpf: "952.935.581-53" },
            { nome: "ROSIRENE GON√áALVES PIRES", cpf: "921.326.186-15" },
            { nome: "VERA LUCIA DE LEMOS PEREIRA DA CRUZ", cpf: "018.455.171-48" },
            { nome: "WATINA LORRAINE MARTINS", cpf: "058.233.501-98" }
        ];

        // Detalhes base do recibo
        const receiptBaseDetails = {
            payer: "BER√á√ÅRIO E ESCOLA CRESCER FELIZ LTDA",
            cnpj: "32.741.557/0001-70",
            description: "REFERENTE AO VALE TRANSPORTE",
            dailyValue: 8.60, // Valor di√°rio do vale transporte
            fixedBonusAmount: 200.00, // Valor fixo da bonifica√ß√£o
            location: "Goi√¢nia"
        };

        // Feriados de 2025
        const holidays2025 = [ 
            {date: "2025-01-01", name: "Confraterniza√ß√£o Universal"},
            {date: "2025-03-03", name: "Carnaval (Ponto Facultativo)"},
            {date: "2025-03-04", name: "Carnaval (Ponto Facultativo)"},
            {date: "2025-04-18", name: "Paix√£o de Cristo"},
            {date: "2025-04-21", name: "Tiradentes"},
            {date: "2025-05-01", name: "Dia do Trabalho"},
            {date: "2025-06-19", name: "Corpus Christi (Ponto Facultativo)"},
            {date: "2025-09-07", name: "Independ√™ncia do Brasil"},
            {date: "2025-10-12", name: "Nossa Senhora Aparecida"},
            {date: "2025-10-24", name: "Anivers√°rio de Goi√¢nia"}, 
            {date: "2025-11-02", name: "Finados"},
            {date: "2025-11-15", name: "Proclama√ß√£o da Rep√∫blica"},
            {date: "2025-11-20", name: "Consci√™ncia Negra"},
            {date: "2025-12-25", name: "Natal"}
        ];
        
        // Elementos do DOM
        const employeeListEl = document.getElementById('employeeList');
        const searchInputEl = document.getElementById('searchInput');
        const welcomeMessageEl = document.getElementById('welcome-message');
        const receiptContentEl = document.getElementById('receipt-content');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const workingDaysInfoEl = document.getElementById('workingDaysInfo');
        const calculateDaysButtonEl = document.getElementById('calculateDaysButton');
        const holidaysInPeriodEl = document.getElementById('holidaysInPeriod');
        
        const confirmationModalEl = document.getElementById('confirmationModal');
        const modalEmployeeNameEl = document.getElementById('modalEmployeeName');
        const confirmButtonEl = document.getElementById('confirmButton');
        const cancelButtonEl = document.getElementById('cancelButton');

        // Novos elementos para sele√ß√£o de tipo de recibo e campos espec√≠ficos
        const receiptTypeSelectionEl = document.getElementById('receiptTypeSelection');
        const internPeriodContainerEl = document.getElementById('internPeriodContainer');
        const internPeriodSelectEl = document.getElementById('internPeriod');
        const receiptTitleEl = document.getElementById('receipt-title');

        // Elementos do calend√°rio
        const calendarEl = document.getElementById('calendar');
        const currentMonthYearEl = document.getElementById('currentMonthYear');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const clearMarkingButton = document.getElementById('clearMarkingButton'); // Novo bot√£o para limpar marca√ß√µes
        const generateReceiptButton = document.getElementById('generateReceiptButton'); // Novo bot√£o para gerar recibo

        // Elementos do novo modal de mensagem
        const messageModalEl = document.getElementById('messageModal');
        const messageModalTitleEl = document.getElementById('messageModalTitle');
        const messageModalContentEl = document.getElementById('messageModalContent');
        const messageModalCloseButton = document.getElementById('messageModalCloseButton');

        // Elementos para adicionar/remover funcion√°rias
        const newEmployeeNameInput = document.getElementById('newEmployeeName');
        const newEmployeeCpfInput = document.getElementById('newEmployeeCpf');
        const addEmployeeButton = document.getElementById('addEmployeeButton');

        // Elementos do novo modal de confirma√ß√£o de exclus√£o
        const deleteConfirmationModalEl = document.getElementById('deleteConfirmationModal');
        const deleteEmployeeNameEl = document.getElementById('deleteEmployeeName');
        const cancelDeleteButton = document.getElementById('cancelDeleteButton');
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');

        let paymentChart = null;
        let currentReceiptNumber = 99;
        let selectedEmployeeForReceipt = null; // Armazena a funcion√°ria selecionada
        let calculatedWorkingDays = 0; // Dias √∫teis efetivos
        let holidaysFoundInPeriod = [];
        let selectedAbsenceDates = new Set(); // Usando Set para armazenar datas de falta
        let selectedCertificateDates = new Set(); // Usando Set para armazenar datas de atestado
        let selectedReceiptType = 'valeTransporte'; // Tipo de recibo padr√£o
        let currentCalendarMonth = new Date().getMonth();
        let currentCalendarYear = new Date().getFullYear();
        let currentMarkType = 'absence'; // Tipo de marca√ß√£o padr√£o para o calend√°rio
        let employeeToDeleteCpf = null; // Armazena o CPF da funcion√°ria a ser exclu√≠da temporariamente


        // Formata um valor num√©rico para a moeda brasileira (BRL)
        function formatCurrency(value) {
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }
        
        // Formata uma string de data (YYYY-MM-DD) para o formato DD/MM/YYYY
        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00'); // Garante fuso hor√°rio local
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Obt√©m a data atual formatada como "DD de [M√™s] de AAAA"
        function getCurrentDateFormatted() {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const monthNames = ["janeiro", "fevereiro", "mar√ßo", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"];
            const month = monthNames[today.getMonth()];
            const year = today.getFullYear();
            return `${day} de ${month} de ${year}`;
        }

        // Define a data atual no elemento do recibo
        document.getElementById('current-date-receipt').textContent = getCurrentDateFormatted();

        // Converte um n√∫mero em sua representa√ß√£o por extenso em portugu√™s (para valores monet√°rios)
        function numberToWords(num) {
            // Adicionado tratamento expl√≠cito para NaN, null ou undefined
            if (num === null || num === undefined || isNaN(num)) {
                return "Zero Reais"; 
            }
            
            const [reais, centavosStr] = num.toFixed(2).split('.');
            let reaisNum = parseInt(reais);
            let centavosNum = parseInt(centavosStr);

            const unidades = ["", "Um", "Dois", "Tr√™s", "Quatro", "Cinco", "Seis", "Sete", "Oito", "Nove"];
            const especiais = ["Dez", "Onze", "Doze", "Treze", "Catorze", "Quinze", "Dezesseis", "Dezessete", "Dezoito", "Dezenove"];
            const dezenas = ["", "", "Vinte", "Trinta", "Quarenta", "Cinquenta", "Sessenta", "Setenta", "Oitenta", "Noventa"];
            const centenas = ["", "Cento", "Duzentos", "Trezentos", "Quatrocentos", "Quinhentos", "Seiscentos", "Setecentos", "Oitocentos", "Novecentos"];

            function getWords(n) {
                if (n === 0) return "";
                let str = "";
                if (n >= 100) {
                    if (n === 100) str += "Cem";
                    else str += centenas[Math.floor(n / 100)];
                    n %= 100;
                    if (n > 0) str += " e ";
                }
                if (n >= 20) {
                    str += dezenas[Math.floor(n / 10)];
                    n %= 10;
                    if (n > 0) str += " e ";
                } else if (n >= 10) {
                    str += especiais[n - 10];
                    n = 0;
                }
                if (n > 0) {
                    str += unidades[n];
                }
                return str;
            }

            let reaisText = getWords(reaisNum);
            if (reaisNum === 0) reaisText = "Zero";
            reaisText += reaisNum === 1 ? " Real" : " Reais";

            let centavosText = "";
            if (centavosNum > 0) {
                centavosText = getWords(centavosNum);
                centavosText += centavosNum === 1 ? " Centavo" : " Centavos";
            }
            
            return reaisText + (centavosNum > 0 ? " e " + centavosText : "");
        }

        // Renderiza o calend√°rio para o m√™s e ano atuais
        function renderCalendar() {
            calendarEl.innerHTML = '';
            const today = new Date();
            const firstDayOfMonth = new Date(currentCalendarYear, currentCalendarMonth, 1);
            const lastDayOfMonth = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            const firstDayOfWeek = firstDayOfMonth.getDay(); // 0 for Sunday, 1 for Monday, etc.

            const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const dayNames = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"];

            currentMonthYearEl.textContent = `${monthNames[currentCalendarMonth]} ${currentCalendarYear}`;

            // Adiciona os cabe√ßalhos dos dias da semana
            dayNames.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day header';
                dayHeader.textContent = day;
                calendarEl.appendChild(dayHeader);
            });

            // Preenche os dias do m√™s anterior
            for (let i = 0; i < firstDayOfWeek; i++) {
                const prevMonthDate = new Date(currentCalendarYear, currentCalendarMonth, 0 - (firstDayOfWeek - 1 - i));
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day other-month disabled-for-marking'; // Desabilita dias de outros meses
                dayEl.textContent = prevMonthDate.getDate();
                calendarEl.appendChild(dayEl);
            }

            // Obt√©m as datas de in√≠cio e fim do per√≠odo selecionado
            const periodStartDate = startDateInput.value ? new Date(startDateInput.value + 'T00:00:00') : null;
            const periodEndDate = endDateInput.value ? new Date(endDateInput.value + 'T00:00:00') : null;

            // Preenche os dias do m√™s atual
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentCalendarYear, currentCalendarMonth, day);
                const isoDateString = date.toISOString().split('T')[0];
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day current-month';
                dayEl.textContent = day;
                dayEl.dataset.date = isoDateString; // Armazena a data ISO para f√°cil refer√™ncia

                // Adiciona classes para feriados, faltas, atestados e hoje
                if (holidays2025.some(h => h.date === isoDateString)) {
                    dayEl.classList.add('holiday');
                }
                if (selectedAbsenceDates.has(isoDateString)) {
                    dayEl.classList.add('selected-absence');
                }
                if (selectedCertificateDates.has(isoDateString)) {
                    dayEl.classList.add('selected-certificate');
                }
                if (isoDateString === today.toISOString().split('T')[0]) {
                    dayEl.classList.add('today');
                }

                // Verifica se o dia est√° dentro do per√≠odo selecionado para habilitar a marca√ß√£o
                if (periodStartDate && periodEndDate && date >= periodStartDate && date <= periodEndDate) {
                    dayEl.addEventListener('click', () => toggleDateSelection(isoDateString, dayEl));
                } else {
                    dayEl.classList.add('disabled-for-marking'); // Desabilita dias fora do per√≠odo
                }
                calendarEl.appendChild(dayEl);
            }

            // Preenche os dias do pr√≥ximo m√™s
            const totalDaysDisplayed = firstDayOfWeek + daysInMonth;
            const remainingDays = 42 - totalDaysDisplayed; // 6 rows * 7 days = 42 cells
            for (let i = 1; i <= remainingDays; i++) {
                const nextMonthDate = new Date(currentCalendarYear, currentCalendarMonth + 1, i);
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day other-month disabled-for-marking'; // Desabilita dias de outros meses
                dayEl.textContent = nextMonthDate.getDate();
                calendarEl.appendChild(dayEl);
            }
        }

        // Alterna a sele√ß√£o de uma data como falta, atestado ou limpa a marca√ß√£o
        function toggleDateSelection(dateString, element) {
            const date = new Date(dateString + 'T00:00:00');
            const periodStartDate = startDateInput.value ? new Date(startDateInput.value + 'T00:00:00') : null;
            const periodEndDate = endDateInput.value ? new Date(endDateInput.value + 'T00:00:00') : null;

            // Impede a marca√ß√£o se a data estiver fora do per√≠odo selecionado
            if (!periodStartDate || !periodEndDate || date < periodStartDate || date > periodEndDate) {
                return;
            }

            if (currentMarkType === 'absence') {
                if (selectedAbsenceDates.has(dateString)) {
                    selectedAbsenceDates.delete(dateString);
                    element.classList.remove('selected-absence');
                } else {
                    selectedAbsenceDates.add(dateString);
                    element.classList.add('selected-absence');
                    selectedCertificateDates.delete(dateString); // Remove de atestado se for marcado como falta
                    element.classList.remove('selected-certificate');
                }
            } else if (currentMarkType === 'certificate') {
                if (selectedCertificateDates.has(dateString)) {
                    selectedCertificateDates.delete(dateString);
                    element.classList.remove('selected-certificate');
                } else {
                    selectedCertificateDates.add(dateString);
                    element.classList.add('selected-certificate');
                    selectedAbsenceDates.delete(dateString); // Remove de falta se for marcado como atestado
                    element.classList.remove('selected-absence');
                }
            }
            // Recalcula os dias efetivos ap√≥s a altera√ß√£o
            calculateEffectiveDays();
        }

        // Navega√ß√£o do calend√°rio
        prevMonthBtn.addEventListener('click', () => {
            currentCalendarMonth--;
            if (currentCalendarMonth < 0) {
                currentCalendarMonth = 11;
                currentCalendarYear--;
            }
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentCalendarMonth++;
            if (currentCalendarMonth > 11) {
                currentCalendarMonth = 0;
                currentCalendarYear++;
            }
            renderCalendar();
        });

        // Atualiza o tipo de marca√ß√£o selecionado (falta, atestado, limpar)
        document.querySelectorAll('input[name="markType"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                currentMarkType = e.target.value;
            });
        });

        // Listener para o novo bot√£o "Limpar Atestados e Faltas"
        clearMarkingButton.addEventListener('click', () => {
            selectedAbsenceDates.clear();
            selectedCertificateDates.clear();
            renderCalendar(); // Re-renderiza o calend√°rio para remover as marca√ß√µes visuais
            calculateEffectiveDays(); // Recalcula os dias √∫teis
            showMessageModal("Marca√ß√µes Limpas", "Todas as marca√ß√µes de falta e atestado foram limpas.");
        });


        // Calcula os dias √∫teis efetivos, considerando fins de semana, feriados, faltas e atestados
        function calculateEffectiveDays() {
            const startDate = new Date(startDateInput.value + 'T00:00:00');
            const endDate = new Date(endDateInput.value + 'T00:00:00');

            // --- VALIDA√á√ÉO: O per√≠odo selecionado deve estar contido no mesmo m√™s ---
            if (isNaN(startDate) || isNaN(endDate) || startDate > endDate) {
                // N√£o √© um erro se as datas n√£o est√£o preenchidas, apenas n√£o calcula
                workingDaysInfoEl.textContent = "0";
                holidaysInPeriodEl.textContent = "Nenhum";
                calculatedWorkingDays = 0;
                holidaysFoundInPeriod = [];
                return { effectiveDays: 0, totalAbsenceCertificateDays: 0 };
            }
            
            if (startDate.getMonth() !== endDate.getMonth() || startDate.getFullYear() !== endDate.getFullYear()) {
                showMessageModal("Erro de Per√≠odo", "O per√≠odo selecionado deve estar contido no mesmo m√™s.");
                workingDaysInfoEl.textContent = "0";
                holidaysInPeriodEl.textContent = "Nenhum";
                calculatedWorkingDays = 0;
                holidaysFoundInPeriod = [];
                return { effectiveDays: 0, totalAbsenceCertificateDays: 0 };
            }
            // --- FIM DA VALIDA√á√ÉO ---

            let count = 0; // Dias √∫teis efetivos
            holidaysFoundInPeriod = []; // Reinicia a lista de feriados encontrados
            let totalAbsenceAndCertificateDays = 0; // Total de dias de falta/atestado
            const currentDate = new Date(startDate);

            // Itera sobre cada dia no per√≠odo
            while (currentDate <= endDate) {
                const dayOfWeek = currentDate.getDay();
                const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6); // 0 = Domingo, 6 = S√°bado
                
                const isoDateString = currentDate.toISOString().split('T')[0];
                const holiday = holidays2025.find(h => h.date === isoDateString);
                const isHoliday = holiday !== undefined;

                const isAbsenceDay = selectedAbsenceDates.has(isoDateString);
                const isCertificateDay = selectedCertificateDates.has(isoDateString);

                // Se n√£o for fim de semana nem feriado
                if (!isWeekend && !isHoliday) {
                    if (!isAbsenceDay && !isCertificateDay) {
                        count++; // √â um dia √∫til efetivo
                    } else {
                        totalAbsenceAndCertificateDays++; // √â um dia de falta/atestado
                    }
                } else if (isHoliday) {
                    holidaysFoundInPeriod.push(holiday); // Adiciona o feriado √† lista
                }
                currentDate.setDate(currentDate.getDate() + 1); // Avan√ßa para o pr√≥ximo dia
            }
            calculatedWorkingDays = count;
            workingDaysInfoEl.textContent = calculatedWorkingDays;
            
            // Atualiza a exibi√ß√£o dos feriados no per√≠odo na barra lateral
            if (holidaysFoundInPeriod.length > 0) {
                holidaysInPeriodEl.textContent = holidaysFoundInPeriod.map(h => `${formatDate(h.date)} (${h.name})`).join(', ');
            } else {
                holidaysInPeriodEl.textContent = "Nenhum";
            }

            return { effectiveDays: calculatedWorkingDays, totalAbsenceCertificateDays: totalAbsenceAndCertificateDays };
        }
        
        // Adiciona o listener para o bot√£o de calcular dias
        calculateDaysButtonEl.addEventListener('click', calculateEffectiveDays);

        // Lida com a mudan√ßa do tipo de recibo selecionado
        function handleReceiptTypeChange() {
            selectedReceiptType = document.querySelector('input[name="receiptType"]:checked').value;
            
            // Esconde o cont√™iner de per√≠odo do estagi√°rio
            internPeriodContainerEl.classList.add('hidden');
            
            // Mostra o cont√™iner relevante com base no tipo selecionado
            if (selectedReceiptType === 'salarioEstagiario') {
                internPeriodContainerEl.classList.remove('hidden');
            }
            // N√£o h√° mais um cont√™iner espec√≠fico para bonifica√ß√£o, pois o valor √© fixo.

            // Recalcula os dias se as datas j√° estiverem definidas
            calculateEffectiveDays();
        }

        // Adiciona listeners para os bot√µes de r√°dio de tipo de recibo
        document.querySelectorAll('input[name="receiptType"]').forEach(radio => {
            radio.addEventListener('change', handleReceiptTypeChange);
        });

        // Renderiza a lista de funcion√°rias com base em um filtro de pesquisa
        function renderEmployeeList(filter = '') {
            employeeListEl.innerHTML = '';
            const filteredData = employeeData.filter(emp => emp.nome.toLowerCase().includes(filter.toLowerCase()));
            
            if (filteredData.length === 0) {
                employeeListEl.innerHTML = `<p class="text-stone-500 p-4 text-center">Nenhuma funcion√°ria encontrada.</p>`;
                return;
            }

            filteredData.forEach(employee => {
                const item = document.createElement('div');
                item.className = 'p-3 mb-2 rounded-lg cursor-pointer hover:bg-teal-50 border-b border-stone-200 employee-item flex justify-between items-center';
                item.innerHTML = `
                    <span>${employee.nome}</span>
                    <button class="text-red-500 hover:text-red-700 ml-2" data-cpf="${employee.cpf}" onclick="showDeleteConfirmationModal('${employee.cpf}', '${employee.nome}')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                        </svg>
                    </button>
                `;
                item.dataset.cpf = employee.cpf; // Armazena o CPF para f√°cil acesso
                item.onclick = (event) => { // Modified to prevent button click from selecting employee
                    if (!event.target.closest('button')) {
                        selectEmployee(employee, item);
                    }
                };
                employeeListEl.appendChild(item);
            });
            // Adiciona a classe 'selected' se a funcion√°ria j√° estiver selecionada
            if (selectedEmployeeForReceipt) {
                const currentSelectedEl = employeeListEl.querySelector(`[data-cpf="${selectedEmployeeForReceipt.cpf}"]`);
                if (currentSelectedEl) {
                    currentSelectedEl.classList.add('selected');
                }
            }
        }

        // Fun√ß√£o para selecionar uma funcion√°ria
        function selectEmployee(employee, element) {
            // Remove a classe 'selected' de qualquer funcion√°ria previamente selecionada
            const currentlySelected = employeeListEl.querySelector('.employee-item.selected');
            if (currentlySelected) {
                currentlySelected.classList.remove('selected');
            }
            // Adiciona a classe 'selected' √† funcion√°ria clicada
            element.classList.add('selected');
            selectedEmployeeForReceipt = employee;
            showMessageModal("Funcion√°ria Selecionada", `Funcion√°ria selecionada: ${employee.nome}`);

            // --- Limpar todos os campos ao selecionar um novo funcion√°rio ---
            startDateInput.value = '';
            endDateInput.value = '';
            workingDaysInfoEl.textContent = "0";
            holidaysInPeriodEl.textContent = "Nenhum";
            selectedAbsenceDates.clear();
            selectedCertificateDates.clear();
            
            // Redefinir o calend√°rio para o m√™s atual
            const today = new Date();
            currentCalendarMonth = today.getMonth();
            currentCalendarYear = today.getFullYear();
            renderCalendar(); // Re-renderiza o calend√°rio para remover as marca√ß√µes visuais

            // Redefinir o tipo de recibo para Vale Transporte
            document.querySelector('input[name="receiptType"][value="valeTransporte"]').checked = true;
            handleReceiptTypeChange(); // Chama para atualizar a interface com o tipo de recibo padr√£o

            // Esconder o conte√∫do do recibo e mostrar a mensagem de boas-vindas
            receiptContentEl.classList.add('hidden');
            welcomeMessageEl.classList.remove('hidden');
            // --- FIM DO NOVO ---
        }

        // Fun√ß√£o para adicionar uma nova funcion√°ria
        function addEmployee() {
            const name = newEmployeeNameInput.value.trim();
            const cpf = newEmployeeCpfInput.value.trim();

            if (!name || !cpf) {
                showMessageModal("Erro de Entrada", "Por favor, preencha o nome e o CPF da nova funcion√°ria.");
                return;
            }

            // Basic CPF format validation (optional, can be more robust)
            const cpfRegex = /^\d{3}\.\d{3}\.\d{3}-\d{2}$/;
            if (!cpfRegex.test(cpf)) {
                showMessageModal("Erro de CPF", "Por favor, insira um CPF v√°lido no formato XXX.XXX.XXX-XX.");
                return;
            }

            // Check if CPF already exists
            if (employeeData.some(emp => emp.cpf === cpf)) {
                showMessageModal("Erro de CPF", "J√° existe uma funcion√°ria com este CPF.");
                return;
            }

            employeeData.push({ nome: name, cpf: cpf });
            renderEmployeeList();
            newEmployeeNameInput.value = '';
            newEmployeeCpfInput.value = '';
            showMessageModal("Sucesso", `Funcion√°ria "${name}" adicionada com sucesso!`);
        }

        // Fun√ß√£o para remover uma funcion√°ria (agora chamada ap√≥s confirma√ß√£o)
        function performRemoveEmployee() {
            if (!employeeToDeleteCpf) return; // Should not happen if called correctly

            const initialLength = employeeData.length;
            employeeData = employeeData.filter(emp => emp.cpf !== employeeToDeleteCpf);
            
            if (employeeData.length < initialLength) {
                renderEmployeeList();
                // If the removed employee was the selected one, clear selection
                if (selectedEmployeeForReceipt && selectedEmployeeForReceipt.cpf === employeeToDeleteCpf) {
                    selectedEmployeeForReceipt = null;
                    receiptContentEl.classList.add('hidden');
                    welcomeMessageEl.classList.remove('hidden');
                }
                showMessageModal("Sucesso", `Funcion√°ria removida com sucesso!`);
            } else {
                showMessageModal("Erro", "Funcion√°ria n√£o encontrada.");
            }
            employeeToDeleteCpf = null; // Clear the temporary storage
        }

        // Listener para o bot√£o de adicionar funcion√°ria
        addEmployeeButton.addEventListener('click', addEmployee);


        // Exibe o modal de confirma√ß√£o antes de gerar o recibo
        function showConfirmationModal() {
            if (!selectedEmployeeForReceipt) {
                showMessageModal("Erro de Sele√ß√£o", "Por favor, selecione uma funcion√°ria antes de gerar o recibo.");
                return;
            }

            // Recalcula os dias efetivos antes de mostrar o modal para ter os valores mais recentes
            const { effectiveDays, totalAbsenceCertificateDays } = calculateEffectiveDays();

            // Adicionado um check para garantir que o per√≠odo √© v√°lido antes de mostrar o modal
            const startDate = new Date(startDateInput.value + 'T00:00:00');
            const endDate = new Date(endDateInput.value + 'T00:00:00');
            if (isNaN(startDate) || isNaN(endDate) || startDate > endDate || startDate.getMonth() !== endDate.getMonth() || startDate.getFullYear() !== endDate.getFullYear()) {
                showMessageModal("Erro de Per√≠odo", "Por favor, selecione um per√≠odo v√°lido e que esteja contido no mesmo m√™s antes de gerar um recibo.");
                return;
            }

            // --- NOVA L√ìGICA: N√£o gerar bonifica√ß√£o se houver falta ou atestado ---
            if (selectedReceiptType === 'bonificacao' && totalAbsenceCertificateDays > 0) {
                showMessageModal("Erro de Bonifica√ß√£o", "N√£o √© poss√≠vel gerar o recibo devido a falta ou atestado.");
                return; // Impede a abertura do modal e a gera√ß√£o do recibo
            }
            // --- FIM DA NOVA L√ìGICA ---

            if (effectiveDays <= 0 && selectedReceiptType !== 'bonificacao') { // Bonifica√ß√£o pode ser 0 por faltas
                showMessageModal("Erro de Dias √öteis", "O per√≠odo selecionado n√£o resultou em dias √∫teis efetivos. Verifique as datas, feriados, faltas e atestados.");
                return;
            }
            
            modalEmployeeNameEl.textContent = `Gerar recibo para ${selectedEmployeeForReceipt.nome}?`;
            confirmationModalEl.classList.remove('hidden');
        }

        // Esconde o modal de confirma√ß√£o
        function hideConfirmationModal() {
            confirmationModalEl.classList.add('hidden');
        }
        
        // Listener para o bot√£o de confirmar no modal
        confirmButtonEl.addEventListener('click', () => {
            if (selectedEmployeeForReceipt) {
                generateReceipt(selectedEmployeeForReceipt);
            }
            hideConfirmationModal();
        });

        // Listener para o bot√£o de cancelar no modal
        cancelButtonEl.addEventListener('click', hideConfirmationModal);

        // Listener para o novo bot√£o "Gerar Recibo"
        generateReceiptButton.addEventListener('click', showConfirmationModal);

        // Fun√ß√µes para o novo modal de mensagem
        function showMessageModal(title, content) {
            messageModalTitleEl.textContent = title;
            messageModalContentEl.textContent = content;
            messageModalEl.classList.remove('hidden');
        }

        function hideMessageModal() {
            messageModalEl.classList.add('hidden');
        }

        messageModalCloseButton.addEventListener('click', hideMessageModal);

        // Fun√ß√µes para o novo modal de confirma√ß√£o de exclus√£o
        function showDeleteConfirmationModal(cpf, name) {
            employeeToDeleteCpf = cpf;
            deleteEmployeeNameEl.textContent = name;
            deleteConfirmationModalEl.classList.remove('hidden');
        }

        function hideDeleteConfirmationModal() {
            deleteConfirmationModalEl.classList.add('hidden');
            employeeToDeleteCpf = null; // Clear temporary storage
        }

        confirmDeleteButton.addEventListener('click', () => {
            performRemoveEmployee();
            hideDeleteConfirmationModal();
        });

        cancelDeleteButton.addEventListener('click', hideDeleteConfirmationModal);


        // Gera o recibo com base na funcion√°ria selecionada e nos dias √∫teis calculados
        function generateReceipt(employee) {
            welcomeMessageEl.classList.add('hidden');
            receiptContentEl.classList.remove('hidden');
            
            currentReceiptNumber++;
            let totalValue = 0; 
            const { effectiveDays, totalAbsenceCertificateDays } = calculateEffectiveDays(); 

            let receiptDescriptionText = "";
            let receiptTitleText = "";

            if (selectedReceiptType === 'valeTransporte') {
                receiptTitleText = "Recibo de Vale Transporte";
                totalValue = effectiveDays * receiptBaseDetails.dailyValue;
                receiptDescriptionText = "REFERENTE AO VALE TRANSPORTE";
            } else if (selectedReceiptType === 'salarioEstagiario') {
                receiptTitleText = "Recibo de Bolsa Est√°gio";
                const monthlyAllowance = 1100;
                const standardWorkingDaysPerMonth = 22; 
                const dailyAllowance = monthlyAllowance / standardWorkingDaysPerMonth;
                totalValue = effectiveDays * dailyAllowance;
                receiptDescriptionText = `REFERENTE √Ä BOLSA EST√ÅGIO (${internPeriodSelectEl.value === 'matutino' ? 'Per√≠odo Matutino' : 'Per√≠odo Vespertino'})`;
            } else if (selectedReceiptType === 'bonificacao') {
                receiptTitleText = "Recibo de Bonifica√ß√£o";
                const bonusAmount = receiptBaseDetails.fixedBonusAmount; 
                totalValue = bonusAmount;
                receiptDescriptionText = `REFERENTE √Ä BONIFICA√á√ÉO`;
            }

            let words;
            try {
                words = numberToWords(totalValue);
            } catch (e) {
                console.error("Error converting number to words:", e);
                words = "Erro na convers√£o"; 
            }

            receiptTitleEl.textContent = receiptTitleText; 
            document.getElementById('receipt-id').textContent = currentReceiptNumber;
            document.getElementById('receipt-total').textContent = formatCurrency(totalValue);
            document.getElementById('receipt-payer').textContent = receiptBaseDetails.payer;
            document.getElementById('receipt-cnpj').textContent = `CNPJ: ${receiptBaseDetails.cnpj}`;
            document.getElementById('employee-name').textContent = employee.nome;
            document.getElementById('employee-cpf').textContent = employee.cpf;
            document.getElementById('receipt-description').textContent = receiptDescriptionText;
            
            const periodText = `<strong>Per√≠odo:</strong> ${effectiveDays} dia(s) √∫til(eis) efetivo(s) de ${formatDate(startDateInput.value)} at√© ${formatDate(endDateInput.value)}.`;
            document.getElementById('receipt-period-info').innerHTML = periodText;
            
            if (selectedReceiptType === 'valeTransporte') {
                document.getElementById('receipt-daily-value').innerHTML = `<strong>Valor Di√°rio:</strong> ${formatCurrency(receiptBaseDetails.dailyValue)}`;
            } else if (selectedReceiptType === 'salarioEstagiario') {
                document.getElementById('receipt-daily-value').innerHTML = ''; 
            } else if (selectedReceiptType === 'bonificacao') {
                 document.getElementById('receipt-daily-value').innerHTML = `<strong>Valor Fixo Mensal:</strong> ${formatCurrency(receiptBaseDetails.fixedBonusAmount)}`;
            }
            else {
                document.getElementById('receipt-daily-value').innerHTML = ''; 
            }

            const holidaysInfoEl = document.getElementById('receipt-holidays-info');
            let additionalInfo = '';
            if (holidaysFoundInPeriod.length > 0) {
                additionalInfo += `<strong>Feriado(s) no per√≠odo:</strong><br>${holidaysFoundInPeriod.map(h => `- ${formatDate(h.date)}: ${h.name}`).join('<br>')}`;
            }
            if (selectedAbsenceDates.size > 0) {
                const sortedAbsenceDates = Array.from(selectedAbsenceDates).sort();
                additionalInfo += (additionalInfo ? '<br><br>' : '') + `<strong>Dia(s) de Falta:</strong><br>${sortedAbsenceDates.map(d => `- ${formatDate(d)}`).join('<br>')}`;
            }
            if (selectedCertificateDates.size > 0) {
                const sortedCertificateDates = Array.from(selectedCertificateDates).sort();
                additionalInfo += (additionalInfo ? '<br><br>' : '') + `<strong>Dia(s) de Atestado:</strong><br>${sortedCertificateDates.map(d => `- ${formatDate(d)}`).join('<br>')}`;
            }
            holidaysInfoEl.innerHTML = additionalInfo;

            document.getElementById('receipt-total-words').textContent = words; 
            document.getElementById('employee-signature-name').textContent = employee.nome;
            document.getElementById('receipt-location-date').innerHTML = `${receiptBaseDetails.location}, <span id="current-date-receipt">${getCurrentDateFormatted()}</span>.`;
            
            updateChart(employee, totalValue);
        }

        // Atualiza o gr√°fico de compara√ß√£o de pagamento
        function updateChart(selectedEmployee, currentTotal) {
            const ctx = document.getElementById('paymentChart').getContext('2d');
            const averagePayment = 175.50; 

            const data = {
                labels: [selectedEmployee.nome, 'M√©dia Geral (Exemplo)'],
                datasets: [{
                    label: 'Valor do Pagamento (R$)',
                    data: [currentTotal, averagePayment],
                    backgroundColor: [
                        'rgba(13, 148, 136, 0.6)', 
                        'rgba(120, 113, 108, 0.6)' 
                    ],
                    borderColor: [
                        'rgb(13, 148, 136)',
                        'rgb(120, 113, 108)'
                    ],
                    borderWidth: 2
                }]
            };

            const options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.y !== null) { label += formatCurrency(context.parsed.y); }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { callback: function(value) { return 'R$ ' + value; } }
                    }
                }
            };
            
            if (paymentChart) { paymentChart.destroy(); }
            paymentChart = new Chart(ctx, { type: 'bar', data: data, options: options });
        }
        
        searchInputEl.addEventListener('keyup', (e) => renderEmployeeList(e.target.value));

        startDateInput.addEventListener('change', () => {
            if (startDateInput.value) {
                const date = new Date(startDateInput.value);
                currentCalendarMonth = date.getMonth();
                currentCalendarYear = date.getFullYear();
            }
            selectedAbsenceDates.clear(); 
            selectedCertificateDates.clear(); 
            renderCalendar();
            calculateEffectiveDays();
        });

        endDateInput.addEventListener('change', () => {
            selectedAbsenceDates.clear(); 
            selectedCertificateDates.clear(); 
            renderCalendar();
            calculateEffectiveDays();
        });
        
        window.onload = () => {
            renderEmployeeList();
            document.getElementById('current-date-receipt').textContent = getCurrentDateFormatted();
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);

            startDateInput.value = firstDayOfMonth.toISOString().split('T')[0];
            endDateInput.value = lastDayOfMonth.toISOString().split('T')[0];
            
            handleReceiptTypeChange(); 
            calculateEffectiveDays(); 
            renderCalendar(); 
        };

    </script>
</body>
</html>
